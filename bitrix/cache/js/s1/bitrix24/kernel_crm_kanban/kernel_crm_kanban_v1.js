; /* /bitrix/js/crm/kanban/actions.min.js?16548417916501*/
; /* /bitrix/js/crm/kanban/grid.min.js?165484179138281*/
; /* /bitrix/js/crm/kanban/item.min.js?165484179126400*/
; /* /bitrix/js/crm/kanban/column.min.js?165484179119047*/
; /* /bitrix/js/crm/kanban/dropzone.min.js?16548417913837*/
; /* /bitrix/js/crm/kanban/pullmanager.min.js?16548417914083*/

; /* Start:"a:4:{s:4:"full";s:51:"/bitrix/js/crm/kanban/actions.min.js?16548417916501";s:6:"source";s:32:"/bitrix/js/crm/kanban/actions.js";s:3:"min";s:36:"/bitrix/js/crm/kanban/actions.min.js";s:3:"map";s:36:"/bitrix/js/crm/kanban/actions.map.js";}"*/
(function(){"use strict";BX.namespace("BX.CRM.Kanban");BX.CRM.Kanban.Actions={startCallList:function(grid,createActivity){if(typeof BX.CrmCallListHelper==="undefined"){return}if(typeof createActivity==="undefined"){createActivity=true}var gridData=grid.getData();BX.CrmCallListHelper.createCallList({entityType:gridData.entityType,entityIds:grid.getCheckedId(),createActivity:createActivity},function(response){if(!BX.type.isPlainObject(response)){return}if(!response.SUCCESS&&response.ERRORS){var error=response.ERRORS.join(". \n");BX.Kanban.Utils.showErrorDialog(error)}else if(response.SUCCESS&&response.DATA){var data=response.DATA;if(data.RESTRICTION){if(BX.Type.isPlainObject(data.RESTRICTION)&&B24&&B24.licenseInfoPopup){B24.licenseInfoPopup.show("ivr-limit-popup",data.RESTRICTION.HEADER,data.RESTRICTION.CONTENT)}else if(BX.Type.isStringFilled(data.RESTRICTION)){eval(data.RESTRICTION)}}else{var callListId=data.ID;if(createActivity&&BXIM){BXIM.startCallList(callListId,{})}else{(new BX.Crm.Activity.Planner).showEdit({PROVIDER_ID:"CALL_LIST",PROVIDER_TYPE_ID:"CALL_LIST",ASSOCIATED_ENTITY_ID:callListId})}}}})},notifySimpleAction:function(e,t){if(e==="DEAL_CHANGECATEGORY"){e="DEAL_CHANGECATEGORY_LINK"}if(e==="DYNAMIC_CHANGECATEGORY"){e="DYNAMIC_CHANGECATEGORY_LINK"}e="CRM_KANBAN_NOTIFY_"+e;if(typeof BX.message[e]!=="undefined"){var i=BX.message[e];if(BX.type.isPlainObject(t)){for(var n in t){i=i.replace("#"+n+"#",t[n])}}BX.UI.Notification.Center.notify({content:i})}},simpleAction:function(e,t,i){if(e.isMultiSelectMode()){e.resetMultiSelectMode()}return new Promise(function(n,a){e.ajax(t,function(o){var r=e.getData();if(o&&!o.error){if(!i){e.onApplyFilter()}e.stopActionPanel();var s=r.entityType;if(s.indexOf("DYNAMIC")===0){s="DYNAMIC"}if(t.action==="delete"&&t.ignore==="Y"){s+="_IGNORE"}else{s+="_"+t.action.toUpperCase()}if(i!==true){this.notifySimpleAction(s,t)}n(o)}else if(o){if(t.action==="status"){e.stopActionPanel();e.onApplyFilter();if(e.getTypeInfoParam("showPersonalSetStatusNotCompletedText")){var c=r.isDynamicEntity?"CRM_KANBAN_SET_STATUS_NOT_COMPLETED_TEXT_DYNAMIC":"CRM_KANBAN_SET_STATUS_NOT_COMPLETED_TEXT_"+r.entityType;BX.Kanban.Utils.showErrorDialog(BX.message(c));a(new Error(BX.message(c)))}else{BX.Kanban.Utils.showErrorDialog(o.error,o.fatal);a(new Error(o.error))}}else{BX.Kanban.Utils.showErrorDialog(o.error,o.fatal);a(new Error(o.error))}}}.bind(this),function(e){BX.Kanban.Utils.showErrorDialog("Error: "+e,true);a(new Error(e))}.bind(this))}.bind(this))},setAssigned:function(e,t){this.simpleAction(e,{action:"setAssigned",ids:e.getCheckedId(),assignedId:t.entityId,assignedName:t.name},false)},merge:function(e){var t=e.getCheckedId();var i=BX.Crm.BatchMergeManager.getItem(e.getData().gridId);if(i&&!i.isRunning()&&t.length>1){i.setEntityIds(t);i.execute()}},changeCategory:function(e,t){var i="";if(t.url){i=t.url}this.simpleAction(e,{action:"changeCategory",id:e.getCheckedId(),category:t.ID,categoryName:BX.util.htmlspecialchars(t.NAME),categoryLink:i},false)},changeColumn:function(e,t){var i=e.getData();e.firstRenderComplete=false;this.simpleAction(e,{action:"status",entity_id:e.getCheckedId(),status:t.id,statusName:BX.util.htmlspecialchars(t.name),entity_type:i.entityType},false)},delete:function(e,t,i){t=t?t:e.getCheckedId();this.simpleAction(e,{action:"delete",id:t},true).then(function(n){if(i){var a=t.length?i.droppedItems:[i.droppedItem];var o=t.length?BX.message("CRM_KANBAN_DELETE_SUCCESS_MULTIPLE"):BX.message("CRM_KANBAN_DELETE_SUCCESS").replace("#ELEMENT_NAME#",i.droppedItem.data.name);i.empty();i.getDropZoneArea().hide();i.droppedItems=[];e.dropZonesShow=false;e.resetMultiSelectMode();e.resetActionPanel();e.resetDragMode();var r={content:o};if(e.getTypeInfoParam("isRecyclebinEnabled")){r.actions=[{title:BX.message("CRM_KANBAN_DELETE_CANCEL"),events:{click:function(){s.close();BX.ajax.runComponentAction("bitrix:crm.kanban","restore",{mode:"ajax",data:{entityIds:t.length?t:[t],entityTypeId:e.data.entityTypeInt}}).then(function(t){a.forEach(function(t){var i=e.getColumn(t.options.columnId);i.addItem(t)});var i=6e3;BX.UI.Notification.Center.notify({content:BX.message("CRM_KANBAN_DELETE_RESTORE_SUCCESS"),autoHideDelay:i})},function(e){BX.UI.Notification.Center.notify({content:e.errors[0].message})})}}}]}var s=BX.UI.Notification.Center.notify(r)}},function(e){BX.UI.Notification.Center.notify({content:e.errors[0].message})})},deleteAll:function(e){this.confirm(BX.message("CRM_KANBAN_PANEL_ACTION_CONFIRM"),function(){this.simpleAction(e,{action:"delete",id:e.getCheckedId()},false)}.bind(this))},open:function(e,t){if(typeof t==="undefined"){t=false}this.simpleAction(e,{action:"open",id:e.getCheckedId(),flag:t?"Y":"N"},false)},ignore:function(e,t){this.confirm(BX.message("CRM_KANBAN_PANEL_ACTION_CONFIRM"),function(){e.fadeOut();BX.ajax.runComponentAction("bitrix:crm.kanban","excludeEntity",{mode:"ajax",data:{entityType:e.getData().entityType,ids:e.getCheckedId()}}).then(function(t){this.simpleAction(e,{action:"delete",ignore:"Y",id:e.getCheckedId()},false)}.bind(this))}.bind(this))},refreshaccount:function(e){this.simpleAction(e,{action:"refreshAccount",id:e.getCheckedId()},false)},email:function(e){if(BX.CrmActivityEditor&&BX.CrmActivityProvider&&BX.CrmActivityEditor.items["kanban_activity_editor"]){var t=e.getData();var i=[];var n=e.getCheckedId();for(var a=0,o=n.length;a<o;a++){i.push({type:"EMAIL",entityId:n[a],entityType:t.entityType})}BX.CrmActivityEditor.items["kanban_activity_editor"].addEmail({communications:i,communicationsLoaded:true})}},task:function(e){if(typeof window["taskIFramePopup"]!=="undefined"){var t=e.getData();var i="";var n=e.getCheckedId();for(var a=0,o=n.length;a<o;a++){i+=BX.CrmOwnerTypeAbbr.resolve(t.entityType)+"_"+n[a]+";"}window["taskIFramePopup"].add({UF_CRM_TASK:i,TITLE:"CRM: ",TAGS:"crm"})}},confirm:function(e,t){var i=BX.PopupWindowManager.create("crm-kanban-confirm-dialog",null,{titleBar:BX.message("CRM_KANBAN_CONFIRM_TITLE"),content:"",width:400,autoHide:false,overlay:true,closeByEsc:true,closeIcon:true,draggable:{restrict:true}});i.setContent(e);i.setButtons([,new BX.PopupWindowButton({text:BX.message("CRM_KANBAN_CONFIRM_Y"),className:"popup-window-button-accept",events:{click:function(){t();this.popupWindow.close()}}}),new BX.PopupWindowButton({text:BX.message("CRM_KANBAN_CONFIRM_N"),className:"popup-window-button-cancel",events:{click:function(){this.popupWindow.close()}}})]);i.show();return i}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:49:"/bitrix/js/crm/kanban/grid.min.js?165484179138281";s:6:"source";s:29:"/bitrix/js/crm/kanban/grid.js";s:3:"min";s:33:"/bitrix/js/crm/kanban/grid.min.js";s:3:"map";s:33:"/bitrix/js/crm/kanban/grid.map.js";}"*/
(function(){"use strict";BX.namespace("BX.CRM.Kanban");BX.CRM.Kanban.Grid=function(e){BX.Kanban.Grid.apply(this,arguments);BX.addCustomEvent(this,"Kanban.DropZone:onBeforeItemCaptured",BX.delegate(this.onBeforeItemCaptured,this));BX.addCustomEvent(this,"Kanban.DropZone:onBeforeItemRestored",BX.delegate(this.onBeforeItemRestored,this));BX.addCustomEvent(this,"Kanban.Grid:onBeforeItemMoved",BX.delegate(this.onBeforeItemMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnAddedAsync",BX.delegate(this.onColumnAddedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnUpdated",BX.delegate(this.onColumnUpdated,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnMoved",BX.delegate(this.onColumnMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnRemovedAsync",BX.delegate(this.onColumnRemovedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnLoadAsync",BX.delegate(this.onColumnLoadAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStart",BX.delegate(this.onItemDragStartHandler,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStart",BX.delegate(this.setKanbanDragMode,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStop",BX.delegate(this.unSetKanbanDragMode,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStop",BX.delegate(this.stopActionPanel,this));BX.addCustomEvent("BX.Main.Filter:apply",BX.delegate(this.onApplyFilter,this));BX.addCustomEvent("BX.CrmEntityCounterPanel:applyFilter",BX.delegate(this.onApplyFilterCounter,this));BX.addCustomEvent("Crm.PartialEditorDialog.Close",BX.delegate(this.onPartialEditorClose,this));BX.addCustomEvent("onPullEvent-crm",BX.proxy(this.onPullEventHandlerCrm,this));BX.addCustomEvent("onPullEvent-im",BX.proxy(this.onPullEventHandlerCrm,this));BX.addCustomEvent("onCrmActivityTodoChecked",BX.proxy(this.onCrmActivityTodoChecked,this));BX.addCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.onSliderClose,this));BX.addCustomEvent("BX.CRM.Kanban.Item.select",BX.proxy(this.startActionPanel,this));BX.addCustomEvent("BX.UI.ActionPanel:clickResetAllBlock",BX.proxy(this.resetMultiSelectMode,this));BX.addCustomEvent("BX.Crm.EntityEditorSection:onOpenChildMenu",BX.proxy(this.onOpenEditorMenu,this));BX.addCustomEvent("BX.Crm.EntityEditor:onConfigScopeChange",BX.proxy(this.onConfigEditorScopeChange,this));BX.addCustomEvent("BX.Crm.EntityEditor:onConfigReset",BX.proxy(this.onConfigEditorReset,this));BX.addCustomEvent("BX.Crm.EntityEditor:onForceCommonConfigScopeForAll",BX.proxy(this.onForceCommonEditorConfigScopeForAll,this));BX.addCustomEvent("onPopupShow",BX.proxy(this.onPopupShow,this));BX.addCustomEvent("CrmDragItemDragRelease",BX.proxy(this.onEditorDragItemRelease,this));this.bindEvents();BX.CRM.Kanban.Grid.Instance=this};BX.CRM.Kanban.Grid.Instance=null;BX.CRM.Kanban.Grid.getInstance=function(){return BX.CRM.Kanban.Grid.Instance};BX.CRM.Kanban.Grid.prototype={__proto__:BX.Kanban.Grid.prototype,constructor:BX.CRM.Kanban.Grid,accessNotifyDialog:null,loadNewInterval:25,ajaxParams:{},customFieldsPopup:null,customFieldsContainer:null,actionPanel:null,currentNode:null,itemMoving:null,actionItems:[],checkedItems:[],progressBarEditor:null,ccItem:null,restItem:null,popupCancel:null,dropZonesShow:false,schemeInline:null,isBindEvents:false,getChecked:function(){return this.checkedItems},getCheckedId:function(){var e=this.getChecked();var t=[];for(var i=0;i<e.length;i++){t.push(e[i].id)}return t},checkItem:function(e){var t=this.getItem(e);if(!BX.util.in_array(t,this.checkedItems)){t.checked=true;if(!this.isCheckedItem(t)){this.checkedItems.push(t)}BX.addClass(t.checkedButton,"crm-kanban-item-checkbox-checked");BX.addClass(t.container,"crm-kanban-item-selected");BX.onCustomEvent("BX.CRM.Kanban.Item.select",[t])}},isCheckedItem:function(e){var t=this.checkedItems;for(var i=0,n=t.length;i<n;i++){if(t[i]["id"]===e["id"]){return true}}return false},onEditorDragItemRelease:function(){var e=this.getColumns();for(var t=0,i=e.length;t<i;t++){if(!e[t].isEditorOpen()){e[t].cleanEditorNode();e[t].editor=null}}},unCheckItem:function(e){var t=this.getItem(e);if(BX.util.in_array(t,this.checkedItems)){this.checkedItems.splice(this.checkedItems.indexOf(t),1);t.checked=false;BX.removeClass(t.checkedButton,"crm-kanban-item-checkbox-checked");BX.removeClass(t.container,"crm-kanban-item-selected");BX.onCustomEvent("BX.CRM.Kanban.Item.unSelect",[t])}},getPopupCancel:function(e){if(!this.popupCancel){this.popupCancel=new BX.PopupWindow("crm-kanban-popup-cancel",window,{className:"crm-kanban-popup-cancel",autoHide:false,overlay:true,maxWidth:350,buttons:[new BX.PopupWindowButton({text:"OK",className:"ui-btn ui-btn-primary",events:{click:function(){this.popupCancel.close()}.bind(this)}})],closeByEsc:true,events:{onPopupClose:function(){}.bind(this)},closeIcon:true})}this.popupCancel.setContent(e);return this.popupCancel},getItemsForAction:function(e){var t=this.getChecked();this.actionItems=[];if(e){t.splice(this.actionItems.indexOf(e),1)}for(var i=0;i<t.length;i++){this.actionItems.push(parseInt(t[i].id,10))}return this.actionItems},bindEvents:function(){if(!this.isBindEvents){BX.bind(window,"click",function(e){if(this.dropZonesShow){return}this.isItKanban(e.target)?this.currentNode=e.target:this.currentNode=null;if(!BX.findParent(e.target,{className:"main-kanban-item"})&&!BX.findParent(e.target,{className:"ui-action-panel"})){this.stopActionPanel();this.unSetKanbanDragMode()}}.bind(this));BX.bind(window,"keydown",function(e){if(this.dropZonesShow){return}if(e.code==="Escape"){this.resetMultiSelectMode();this.stopActionPanel();this.unSetKanbanDragMode()}}.bind(this));BX.addCustomEvent(window,"Crm.PartialEditorDialog.Close",function(e,t){if(t.isCancelled&&this.itemMoving.item){this.moveItem(this.itemMoving.item,this.itemMoving.oldColumn,this.itemMoving.oldNextSiblingId)}}.bind(this));BX.Event.EventEmitter.subscribe("Crm.Kanban.Column:onItemAdded",function(e){if(this.itemMoving&&this.itemMoving.item.id===e.data.item.id&&this.items[this.itemMoving.item.id]!==undefined&&this.itemMoving.item.columnId===this.items[this.itemMoving.item.id].columnId){this.onItemMoved(e.data.item,e.data.targetColumn,e.data.beforeItem)}}.bind(this));BX.Event.EventEmitter.subscribe("crm-kanban-settings-fields-view",function(){this.showFieldsSelectPopup("view")}.bind(this));BX.Event.EventEmitter.subscribe("crm-kanban-settings-fields-edit",function(){this.showFieldsSelectPopup("edit")}.bind(this));var e=BX.Reflection.getClass("BX.Crm.ToolbarComponent")?BX.Reflection.getClass("BX.Crm.ToolbarComponent").Instance:null;if(this.getData().isDynamicEntity&&e){e.subscribeTypeUpdatedEvent(function(){if(BX.Reflection.getClass("BX.Crm.Router.Instance.getKanbanUrl")){var e=this.getData().hasOwnProperty("entityTypeInt")?BX.Text.toInteger(this.getData().entityTypeInt):0;var t=this.getData().params.hasOwnProperty("CATEGORY_ID")?BX.Text.toInteger(this.getData().params.CATEGORY_ID):0;var i=BX.Crm.Router.Instance.getKanbanUrl(e,t);if(i){window.location.href=i;return}}window.location.reload()}.bind(this));e.subscribeCategoriesUpdatedEvent(function(){this.reload()}.bind(this))}this.isBindEvents=true}},isItKanban:function(e){if(BX.findParent(e,{className:"main-kanban"})){return true}},setKanbanDragMode:function(){BX.addClass(document.body,"crm-kanban-drag-mode")},unSetKanbanDragMode:function(){BX.removeClass(document.body,"crm-kanban-drag-mode")},renderLayout:function(){var e=this.getData();BX.Kanban.Grid.prototype.renderLayout.apply(this,arguments);this.setDropareaFirstItemWidth();if(this.ccItem&&!e.contactCenterShow){this.hideItem(this.ccItem)}if(this.restItem&&!e.restDemoBlockShow){this.hideItem(this.restItem)}},setDropareaFirstItemWidth:function(){var e=document.head;var t=BX.create("style",{attrs:{type:"text/css"}});if(this.layout.gridContainer.firstChild!==null){var i=document.createTextNode(".main-kanban-dropzone:first-child, main-kanban-dropzone:last-child {"+"max-width: "+(this.layout.gridContainer.firstChild.offsetWidth+3)+"px; "+"min-width: "+(this.layout.gridContainer.firstChild.offsetWidth+3)+"px;}");t.appendChild(i);e.appendChild(t)}},getAjaxHandlerPath:function(){var e=this.getData();return BX.type.isNotEmptyString(e.ajaxHandlerPath)?e.ajaxHandlerPath:"/bitrix/components/bitrix/crm.kanban/ajax.old.php"},setAjaxParams:function(e){this.ajaxParams=e},ajax:function(e,t,i,n){var a=this.getData();var o=this.getAjaxHandlerPath();if(typeof n==="undefined"){n="json"}e.sessid=BX.bitrix_sessid();e.extra=a.params;e.entity_type=a.entityType;e.version=2;e.ajaxParams=this.ajaxParams;e.entityPath=a.entityPath;this.setAjaxParams({});if(e.action!=="undefined"){o+=o.indexOf("?")===-1?"?":"&";o+="action="+e.action}if(this.isMultiSelectMode()){o+="&group=yes"}BX.ajax({method:"POST",dataType:n,url:o,data:e,onsuccess:t,onfailure:i})},accessNotify:function(){if(typeof BX.Intranet!=="undefined"&&typeof BX.Intranet.NotifyDialog!=="undefined"){if(this.accessNotifyDialog===null){var e=this.getData();this.accessNotifyDialog=new BX.Intranet.NotifyDialog({listUserData:this.getData().admins,notificationHandlerUrl:this.getAjaxHandlerPath()+"?action=notifyAdmin&version=2&entity_type="+e.entityType,popupTexts:{sendButton:BX.message("CRM_KANBAN_NOTIFY_BUTTON"),title:BX.message("CRM_KANBAN_NOTIFY_TITLE"),header:BX.message("CRM_KANBAN_NOTIFY_HEADER"),description:BX.message("CRM_KANBAN_NOTIFY_TEXT2")}})}this.accessNotifyDialog.show()}},addStage:function(e){var t=new BX.Promise;var i=this.getPreviousColumnSibling(e);var n=i?i.getId():0;this.ajax({action:"modifyStage",columnName:e.getName(),columnColor:e.getColor(),afterColumnId:n},function(e){if(e&&!e.error){this.resetActionPanel();t.fulfill(e)}else if(e){BX.Kanban.Utils.showErrorDialog(e.error,e.fatal);t.reject(e.error)}}.bind(this),function(e){BX.Kanban.Utils.showErrorDialog("Error: "+e,true);t.reject("Error: "+e)}.bind(this));return t},removeStage:function(e){var t=new BX.Promise;this.ajax({action:"modifyStage",columnId:e.getId(),delete:1},function(e){if(e&&!e.error){this.resetActionPanel();t.fulfill()}else if(e){t.reject(e.error)}}.bind(this),function(e){BX.Kanban.Utils.showErrorDialog("Error: "+e,true);t.reject("Error: "+e)}.bind(this));return t},getColumnItems:function(e){var t=new BX.Promise;this.data.params["total"]=e.getTotal();this.data.params["itemsCount"]=e.getItemsCount();e.loadingInProgress=true;this.ajax({action:"page",page:e.getPagination().getPage()+1,column:e.getId()},function(e){if(e&&(BX.type.isArray(e)||BX.type.isArray(e.items))&&!e.error){t.fulfill(BX.type.isArray(e)?e:e.items)}else if(e){BX.Kanban.Utils.showErrorDialog(e.error,e.fatal);t.reject(e.error)}if(this.ccItem){var i=this.getData();if(!i.contactCenterShow){this.hideItem(this.ccItem)}}}.bind(this),function(e){BX.Kanban.Utils.showErrorDialog("Error: "+e,true);t.reject("Error: "+e)}.bind(this));return t},addItemTop:function(e){var t=this.getColumn(e.columnId);var i=t?t.getItems():[];if(i.length>0){e.targetId=i[0].getId()}t?t.incPrice(e.data.price):null;this.addItem(e)},moveItem:function(e,t,i){e=this.getItem(e);t=this.getColumn(t);i=this.getItem(i);var n=e.getColumn();var a=t.getId();var o=this.getData();var r=t.getData();if(!e||!t||e===i){return false}if(this.getChecked().length>1){var s=false;var l=this.getChecked();for(var d=0,u=l.length;d<u;d++){var c=l[d].getData();var m=l[d].getColumn().getId();if(this.getTypeInfoParam("hasRestictionToMoveToWinColumn")&&r.type==="WIN"){s=true;if(l.length===d+1){this.resetMultiSelectMode()}}else if(c.required&&c.required[a]&&c.required[a].length>0&&a!==m){if(c.required_fm){var h=[];for(var g=0,f=c.required[a].length;g<f;g++){var p=c.required[a][g];if(typeof c.required_fm[p]==="undefined"||c.required_fm[p]===true){h.push(c.required[a][g])}}c.required[a]=h}if(c.required[a].length>0){s=true;if(l.length===d+1){this.resetMultiSelectMode()}}}}if(s){var v=BX.message("CRM_KANBAN_SET_STATUS_NOT_COMPLETED_TEXT_"+o.entityType);if(o.isDynamicEntity){v=BX.message("CRM_KANBAN_SET_STATUS_NOT_COMPLETED_TEXT_DYNAMIC")}this.getPopupCancel(v).show()}var C=this.getChecked();for(var d=0;d<C.length;d++){if(C[d]!==e&&C[d].getColumn()!==t){C[d].getColumn().layout.total.textContent=+C[d].getColumn().layout.total.innerHTML-1}n.removeItem(C[d])}t.addItems(this.getChecked(),i);this.resetMultiSelectMode();return}e.beforeItem=i;n.removeItem(e).then(function(){t.addItem(e,e.beforeItem)});return true},loadNew:function(e,t,i){var n=this.getData();var a=typeof e!=="undefined"?e:0;if(document.hidden){return}return new Promise(function(e,o){this.ajax(a?{action:"get",entity_id:a,force:t===true?"Y":"N"}:{action:"get",min_entity_id:n.lastId,force:t===true?"Y":"N"},function(t){if(t&&t.items){var o=false;if(t.items.length>0){var r={};for(var s=t.items.length-1;s>=0;s--){var l=t.items[s];var d=this.getItem(l.id);if(l.id<=0){continue}o=true;if(d){var u=d.getData();var c=d.getColumn();var m=this.getColumn(l.columnId);c.decPrice(parseFloat(u.price));r[c.getId()]=c;if(m){m.incPrice(parseFloat(l.data.price));d.data.price=l.data.price}if(m&&m!==c||i===true){this.updateItem(l.id,l);r[m.getId()]=m}}else if(l.id&&this.getColumn(l.columnId)===null){BX.onCustomEvent(this,"Kanban.Column:render")}else if(l.id){this.addItemTop(l)}if(!a){n.lastId=l.id;this.setData(n)}}for(var h in r){r[h].renderSubTitle()}}if(!o&&a){var l=this.getItem(a);if(l){var g=l.getData();var f=l.getColumn();f.decPrice(g.price);this.removeItem(a)}}}e(t)}.bind(this),function(e){o()}.bind(this))}.bind(this))},onItemDragStart:function(e){this.setDragMode(BX.Kanban.DragMode.ITEM);var t=this.getData();var i=this.getItems();var n=e.getColumn().getData();var a=e.getColumnId();if(parseInt(e.getId())<0){return}if(this.getTypeInfoParam("disableMoveToWin")&&n.type==="WIN"){for(var o in i){var r=i[o].getColumnId();if(r===a){i[o].enableDropping()}}return}BX.Kanban.Grid.prototype.onItemDragStart.apply(this,arguments);if(this.progressBarEditor){this.progressBarEditor.close()}},onItemDragStartHandler:function(e){e.setLastPosition()},onColumnLoadAsync:function(e){e.push(BX.delegate(this.getColumnItems,this))},onColumnRemovedAsync:function(e){e.push(BX.delegate(this.removeStage,this))},onColumnAddedAsync:function(e){e.push(BX.delegate(this.addStage,this))},onBeforeItemCaptured:function(e){BX.onCustomEvent("Crm.Kanban.Grid:onBeforeItemCapturedStart",[this,e]);if(e.isActionAllowed()){var t=e.getItem();var i=t.getColumn();var n=e.getDropZone();this.itemMoving={item:t,price:parseFloat(t.getData().price),oldColumn:i,oldNextSiblingId:i.getNextItemSibling(t),newColumn:null,newNextSibling:null,dropEvent:e,groupIds:this.getItemsForAction()};this.onItemMoved(t,n,null,true);if(n.getId()==="DELETED"){var a=this.getItemsForAction();BX.CRM.Kanban.Actions.delete(this,a.length?a:parseInt(t.getId(),10),n)}}},onBeforeItemRestored:function(e){var t=e.getItem();var i=t.getColumn();var n=parseFloat(t.getData().price);i.incPrice(n);this.onItemMoved(t,i)},onBeforeItemMoved:function(e){var t=e.getItem();var i=t.getColumn();this.itemMoving={item:t,price:parseFloat(t.getData().price),oldColumn:i,oldNextSiblingId:i.getNextItemSibling(t),newColumn:null,newNextSibling:null}},onItemMoved:function(e,t,i,n){var a=e.getData();var o=t.getId();var r=this.getData();var s=t instanceof BX.Kanban.DropZone;var l=a.required&&a.required[o]&&a.required[o].length>0;if(l&&this.itemMoving.oldColumn.getId()!==t.getId()&&!e.isChangedInPullRequest()){if(a.required_fm){var d=[];for(var u=0,c=a.required[o].length;u<c;u++){var m=a.required[o][u];if(typeof a.required_fm[m]==="undefined"||a.required_fm[m]===true){d.push(a.required[o][u])}}a.required[o]=d}if(e.rawData&&typeof e.rawData==="object"){var h=a.required[o];for(var u=0,c=a.required[o].length;u<c;u++){var m=a.required[o][u];if(!(typeof e.rawData[m]==="undefined"||e.rawData[m]===null||e.rawData[m]===""||Array.isArray(e.rawData[m])&&!e.rawData[m].length)){h.splice(u,1)}}a.required[o]=h}if(a.required[o].length>0&&this.getTypeInfoParam("isQuickEditorEnabled")){this.itemMoving.newColumn=t;this.itemMoving.newNextSibling=i;if(s){this.itemMoving.dropEvent.denyAction()}this.openPartialEditor(e.getId(),o,a.required[o]);BX.addClass(e.layout.container,"main-kanban-item-waiting");return}}if(!e.isChangedInPullRequest()){if(this.getTypeInfoParam("canShowPopupForLeadConvert")&&t.getId()==="CONVERTED"&&this.itemMoving.dropEvent){BX.Crm.KanbanComponent.dropPopup(this,this.itemMoving.dropEvent)}if(this.itemMoving.item.getData().runtimePrice!==true){this.itemMoving.oldColumn.decPrice(this.itemMoving.price)}if(!s){t.incPrice(this.itemMoving.price);t.renderSubTitle();this.itemMoving.oldColumn.renderSubTitle()}}this.itemMoving.item.setDataKey("runtimePrice",false);if(n!==true&&!e.isChangedInPullRequest()){var g={grid:this,item:e,targetColumn:t,beforeItem:i,skip:false};BX.onCustomEvent("Crm.Kanban.Grid:onItemMovedFinal",[g]);if(g.skip===true){return}}var f=0;var p=e.getId();var v=t?t.getId():0;if(t instanceof BX.Kanban.DropZone){f=0}else{var C=t.getPreviousItemSibling(e);if(C){f=C.getId()}}BX.removeClass(e.layout.container,"main-kanban-item-waiting");if(this.itemMoving.groupIds&&this.itemMoving.groupIds.length===0){this.itemMoving.groupIds.push(p)}if(!e.isChangedInPullRequest()){this.ajax({action:"status",entity_id:this.itemMoving.groupIds?this.itemMoving.groupIds:p,prev_entity_id:f,status:v},function(t){if(t&&!t.error){if(t.items&&t.items.length>0){this.updateItem(p,t.items[0])}else{e.setDataKey("columnId",v)}}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,true)}}.bind(this),function(e){BX.Kanban.Utils.showErrorDialog("Error: "+e,true)}.bind(this))}if(e.isChangedInPullRequest()){this.clearItemMoving();e.dropChangedInPullRequest()}},onColumnUpdated:function(e){var t=e.getId();var i=e.getName();var n=e.getColor();this.ajax({action:"modifyStage",columnId:t,columnName:i,columnColor:n},function(e){if(e&&e.error){BX.Kanban.Utils.showErrorDialog(e.error,e.fatal)}else{this.resetActionPanel()}}.bind(this),function(e){BX.Kanban.Utils.showErrorDialog("Error: "+e,true)}.bind(this))},onColumnMoved:function(e,t){var i=e.getId();var n=this.getPreviousColumnSibling(e);var a=n?n.getId():0;this.ajax({action:"modifyStage",columnId:i,afterColumnId:a},function(e){if(e&&e.error){BX.Kanban.Utils.showErrorDialog(e.error,true)}else{this.resetActionPanel()}}.bind(this),function(e){BX.Kanban.Utils.showErrorDialog("Error: "+e,true)}.bind(this))},onApplyFilter:function(e,t,i,n,a){this.clearItemMoving();this.fadeOut();if(typeof a!=="undefined"){a.autoResolve=false}this.ajax({action:"get"},function(e){var t=this.getData();if(typeof e.customFields!=="undefined"){t.customFields=e.customFields}if(typeof e.customEditFields!=="undefined"){t.customEditFields=e.customEditFields}if(typeof BX.UI.EntityScheme!=="undefined"&&typeof e.scheme_inline!=="undefined"){t.schemeInline=BX.UI.EntityScheme.create("kanban_scheme",{current:e.scheme_inline})}this.setData(t);this.destroyFieldsSelectPopup();var i=[],a=null;var o=this.getColumns();for(var r=0,s=o.length;r<s;r++){a=o[r].getId();i.push(a);this.removeColumn(a)}this.removeItems();this.loadData(e);var l=this.getDropZoneArea();var d=this.getDropZoneArea().getDropZones();for(var r=0,s=d.length;r<s;r++){l.removeDropZone(d[r])}if(e.dropzones){for(var r=0,s=e.dropzones.length;r<s;r++){l.addDropZone(e.dropzones[r])}}var u=null;o=this.getColumns();for(var r=0,s=o.length;r<s;r++){a=o[r].getId();if(!BX.util.in_array(a,i)){u=o[r]}}if(u!==null){this.addClassEar()}this.fadeIn();if(typeof n!=="undefined"){n.fulfill()}}.bind(this),function(e){if(typeof n!=="undefined"){n.reject()}this.fadeIn()}.bind(this))},clearItemMoving:function(){this.itemMoving=null},addClassEar:function(){var e=document.querySelector(".main-kanban-ear-right");e.classList.contains("crm-kanban-ear-animate")?BX.removeClass("crm-kanban-ear-animate"):null;BX.addClass(e,"crm-kanban-ear-animate")},toggleCC:function(){var e=BX.PopupMenu.getCurrentMenu();if(e){e.close()}if(this.ccItem){var t=this.getData();if(t.contactCenterShow){this.hideItem(this.ccItem)}else{this.unhideItem(this.ccItem)}t.contactCenterShow=!t.contactCenterShow}this.ajax({action:"toggleCC"},function(){}.bind(this),function(e){}.bind(this))},toggleRest:function(){if(this.restItem){this.hideItem(this.restItem)}this.ajax({action:"toggleRest"},function(){}.bind(this),function(e){}.bind(this))},unhideItem:function(e){e=this.getItem(e);if(!e||e.isVisible()){return false}e.setOptions({visible:true});if(e.layout.container&&e.layout.container.classList.contains("main-kanban-item-disabled")){BX.removeClass(e.layout.container,"main-kanban-item-disabled")}if(e.isCountable()){e.getColumn().incrementTotal()}e.getColumn().render();return true},addMenuAdditionalFields:function(e){var t=BX.PopupMenu.getCurrentMenu(e);var i=t.getMenuItems();if(t&&i&&t.bindElement&&BX(t.bindElement)&&BX.hasClass(BX(t.bindElement),"ui-btn-icon-setting")){var n=i.length>0?i[0].getId():0;var a=[{text:BX.message("CRM_KANBAN_SETTINGS_FIELDS_VIEW"),onclick:function(e,t){this.showFieldsSelectPopup("view")}.bind(this)}];if(this.getData().entityType!=="ORDER"){a.push({text:BX.message("CRM_KANBAN_SETTINGS_FIELDS_EDIT"),onclick:function(e,t){this.showFieldsSelectPopup("edit")}.bind(this)})}t.addMenuItem({text:BX.message("CRM_KANBAN_SETTINGS_TITLE"),items:a},n)}},addMenuToggleCS:function(e){var t=this.getData();var i=BX.PopupMenu.getCurrentMenu(e);if(i&&i.bindElement&&BX(i.bindElement)&&BX.hasClass(BX(i.bindElement),"ui-btn-icon-setting")){i.addMenuItem({text:"",delimiter:true},null);i.addMenuItem({text:t.contactCenterShow?BX.message("CRM_KANBAN_HIDE_CC"):BX.message("CRM_KANBAN_SHOW_CC"),onclick:function(e,t){this.toggleCC()}.bind(this)},null)}},addCustomEditField:function(e){var t=this.getData();t.customEditFields.push(e)},removeCustomEditField:function(e){var t=this.getData();t.customEditFields.splice(t.customEditFields.indexOf(e),1)},getQuickEditor:function(){var e=this.getColumns();for(var t=0,i=e.length;t<i;t++){var n=e[t].getQuickEditor();if(n){return n}}return null},showFieldsSelectPopup:function(e,t){var i=this.getData();var n=i.customSectionsFields;var a=Object.assign({},i.customDisabledFields);if(e!=="edit"){e="view"}if(e==="edit"){var o=["ID","CLOSED","CLOSEDATE","DATE_CREATE","DATE_MODIFY","COMMENTS","OPPORTUNITY"];for(var r=0,s=o.length;r<s;r++){a[o[r]]=true}}else{var l=["PHONE","EMAIL","WEB","IM"];for(var r=0,s=l.length;r<s;r++){a[l[r]]=true}}var d=e==="view"?i.customFields:i.customEditFields;if(!this.currentPopupFields){this.currentPopupFields=e}if(this.currentPopupFields!==e){this.currentPopupFields=e;this.destroyFieldsSelectPopup()}var u=BX.Main.PopupManager.getPopupById("kanban_custom_fields");if(!u){u=BX.Main.PopupManager.create("kanban_custom_fields",window.body,{closeIcon:true,offsetLeft:0,lightShadow:true,overlay:true,className:"crm-kanban-popup-field",titleBar:{content:BX.create("span",{html:""})},draggable:true,contentColor:"white",closeByEsc:true,bindOptions:{forceBindPosition:false},maxHeight:window.innerHeight-50,buttons:[new BX.PopupWindowButton({text:BX.message("CRM_KANBAN_POPUP_SAVE"),className:"ui-btn ui-btn-primary",events:{click:function(){var t={};var n={};var a=BX.findChild(this.customFieldsContainer,{tagName:"input",className:"crm-kanban-popup-field-item-input"},true,true);for(var o=0,r=a.length;o<r;o++){if(a[o].checked){t[a[o].getAttribute("name")]=BX.data(a[o],"label");if(e==="view"){i.customFields.push(a[o].getAttribute("name"))}else{i.customEditFields.push(a[o].getAttribute("name"))}if(i.customEditFields.indexOf(a[o].getAttribute("name"))===-1){if(e!=="view"){this.addCustomEditField(a[o].getAttribute("name"))}}}else{n[a[o].getAttribute("name")]=BX.data(a[o],"label");if(i.customEditFields.indexOf(a[o].getAttribute("name"))!==-1){this.removeCustomEditField(a[o].getAttribute("name"))}}}this.ajax({action:"saveFields",fields:t,type:e},function(i){if(e==="view"){this.onApplyFilter()}else{var a=[];var o=[];var r=this.getColumns();var s=this.getQuickEditor();var l=s.getControlById("main");for(var d in t){if(l.getChildById(d)===null){a.push(d)}}for(var d in n){if(l.getChildById(d)!==null){o.push(d)}}var r=this.getColumns();for(var u=0,c=r.length;u<c;u++){var s=r[u].getQuickEditor();if(!s){continue}for(var m=0,h=a.length;m<h;m++){var g=s.getAvailableSchemeElementByName(a[m]);if(g){var f=s.createControl(g.getType(),g.getName(),{schemeElement:g,model:s._model,mode:s._mode});if(f){var p=s.getControlById("main");p.addChild(f,{layout:{forceDisplay:true},enableSaving:false})}}}for(var v=0,C=o.length;v<C;v++){var g=s.getSchemeElementByName(o[v]);if(g){var p=s.getControlById("main");var I=p.getChildById(o[v]);if(I){p.removeChild(I,{enableSaving:false})}}}s.commitSchemeChanges()}this.getQuickEditor().saveSchemeChanges().then(function(){for(var e=0,t=r.length;e<t;e++){var i=r[e].getQuickEditor();if(i){i.refreshLayout()}}})}}.bind(this),function(e){}.bind(this));u.close()}.bind(this)}}),new BX.PopupWindowButton({text:BX.message("CRM_KANBAN_POPUP_CANCEL"),className:"ui-btn ui-btn-link",events:{click:function(){u.close();this.destroyFieldsSelectPopup()}.bind(this)}})]});var c=BX.create("div",{props:{className:"crm-kanban-popup-field-loader"}});var m=new BX.Loader({target:c,size:80});m.show();u.setContent(c);u.setTitleBar(BX.message("CRM_KANBAN_CUSTOM_FIELDS_"+e.toUpperCase()));var h=this.getQuickEditor();if(h){var g=h.getControlById("main")}BX.ajax.runComponentAction("bitrix:crm.kanban","getFields",{mode:"ajax",data:{entityType:i.entityType,viewType:e}}).then(function(t){var i=t.data;m.destroy();var o=[];var r=[];var s=i;var l=[];var c=true;for(var h=0,f=n.length;h<f;h++){r=s;s=[];l=[];c=true;for(var p=0,v=r.length;p<v;p++){if(a[r[p].NAME]===true){continue}if(n[h]["elements"]!=="*"){if(!n[h]["elements"][r[p].NAME]){s.push(r[p]);continue}if(n[h]["elements"][r[p].NAME]["title"]){r[p].LABEL=n[h]["elements"][r[p].NAME]["title"]}}if(c&&f>1){c=false;o.push(BX.create("div",{props:{className:"crm-kanban-popup-field-title"},text:n[h]["title"]}))}var C,I;var b=false;if(e==="edit"){b=typeof g!=="undefined"&&g.getChildById(r[p].NAME)!==null}else{b=BX.util.in_array(r[p].NAME,d)}l.push(BX.create("div",{props:{className:"crm-kanban-popup-field-item",title:r[p].LABEL},children:[C=BX.create("input",{props:{id:"cf_"+r[p].ID,type:"checkbox",name:r[p].NAME,checked:b,className:"crm-kanban-popup-field-item-input"},dataset:{label:r[p].LABEL}}),I=BX.create("label",{attrs:{for:"cf_"+r[p].ID,className:"crm-kanban-popup-field-item-label"},text:r[p].LABEL,events:{click:function(e){var t=B.querySelectorAll(".crm-kanban-popup-field-item-input:checked");var i=this.parentNode.querySelector(".crm-kanban-popup-field-item-input");if(i.checked&&t.length<=1){this.parentNode.style.pointerEvents="none";var n=BX.PopupWindowManager.create(null,i,{autoHide:true,animation:"fading-slide",darkMode:true,content:BX.message("CRM_KANBAN_POPUP_AT_LEAST_ONE_FIELD"),zIndex:9999,events:{onPopupClose:function(){this.parentNode.style.pointerEvents=null;n.destroy()}.bind(this)}});n.show();setTimeout(function(){this.parentNode.style.pointerEvents=null;n.destroy()}.bind(this),2e3);BX.PreventDefault(e);return}if(i.checked){this.parentNode.classList.remove("crm-kanban-popup-field-item-checked");i.checked=false}else{this.parentNode.classList.add("crm-kanban-popup-field-item-checked");i.checked=true}BX.PreventDefault(e)}}})]}))}o.push(BX.create("div",{props:{className:"crm-kanban-popup-field-wrapper"},children:l}))}this.customFieldsContainer=BX.create("div",{props:{className:"crm-kanban-popup-field"},children:o});var B=this.customFieldsContainer;u.setContent(this.customFieldsContainer);u.adjustPosition()}.bind(this)).catch(function(e){BX.Kanban.Utils.showErrorDialog(e.errors.pop().message)})}u.show()},destroyFieldsSelectPopup:function(){var e=BX.Main.PopupManager.getPopupById("kanban_custom_fields");if(e){e.destroy()}},onApplyFilterCounter:function(e,t){setTimeout(BX.delegate(function(){var e=this.getData();var i={ASSIGNED_BY_ID:{0:t["userId"]},ASSIGNED_BY_ID_label:[t["userName"]],ACTIVITY_COUNTER:{0:t["counterTypeId"]}};var n=BX.Main.filterManager.getById(e.gridId);var a=n.getApi();a.setFields(i);a.apply({COUNTER:this.getAnalyticsLabel(t["counterTypeId"])})},this),0);t["cancel"]=true},getAnalyticsLabel:function(e){var t=this.getData().entityType;if(t&&e){return"CRM_"+t+"_COUNTER_TYPE_"+e}return""},onPartialEditorClose:function(e,t){BX.removeClass(this.itemMoving.item.layout.container,"main-kanban-item-waiting");if(t.isCancelled){return}var i=false;if(t.entityData){var n=this.itemMoving.item.getData();var a=this.itemMoving.newColumn.getId();if(n.required&&n.required[a]){var o=n.required[a];var r=false;var s={};for(var l in n.required_fm){if(t.entityData[l]){n.required_fm[l]=false;s[l]=true}}var d=[];for(var u=0,c=o.length;u<c;u++){var m=o[u];if(s[m]){r=false}else if(t.entityData[m]&&(typeof t.entityData[m]==="object"&&t.entityData[m].IS_EMPTY===false||typeof t.entityData[m]!=="object"&&t.entityData[m]!=="")){r=false}else if(m==="OPPORTUNITY_WITH_CURRENCY"&&parseFloat(t.entityData["OPPORTUNITY"])>0){this.itemMoving.item.setDataKey("runtimePrice",true);r=false}else if(m==="CLIENT"&&(parseInt(t.entityData["CONTACT_ID"])>0||parseInt(t.entityData["COMPANY_ID"])>0)){r=false}else if(m==="FILES"&&(BX.Type.isArray(t.entityData["STORAGE_ELEMENT_IDS"])&&t.entityData["STORAGE_ELEMENT_IDS"].reduce(function(e,t){return e+t},0)>0)){r=false}else if(m==="OBSERVER"&&t.entityData["OBSERVER_IDS"].length){r=false}else{r=true}if(!r){for(var h in n.required){var g=n.required[h];for(var f=0,p=g.length;f<p;f++){if(g[f]===m){g=BX.util.deleteFromArray(g,f);break}}n.required[h]=g}}else{i=true}}this.itemMoving.item.setDataKey("required",n.required);this.itemMoving.item.setDataKey("required_fm",n.required_fm);if(t.entityData["OPPORTUNITY"]){this.itemMoving.price=parseFloat(t.entityData["OPPORTUNITY"]);this.itemMoving.item.setDataKey("price",this.itemMoving.price);this.itemMoving.item.setDataKey("price_formatted",t.entityData["FORMATTED_OPPORTUNITY_WITH_CURRENCY"])}}}if(this.itemMoving.newColumn instanceof BX.Kanban.DropZone){this.itemMoving.newColumn.captureItem(this.itemMoving.item)}else{if(!i){this.moveItem(this.itemMoving.item,this.itemMoving.newColumn,this.itemMoving.newNextSibling)}}},onPullEventHandlerCrm:function(e,t){var i=this.getData();if(e==="notify"){if(i.entityType==="INVOICE"&&t.settingName==="crm|invoice_responsible_changed"){var n=t.originalTag.match(new RegExp("CRM\\|"+i.entityType+"\\|([\\d]+)"));if(n&&n[1]){this.loadNew(n[1])}}}},onCrmActivityTodoChecked:function(e,t,i,n){var a=this.getItem(t);if(a){if(n){var o=a.getDataKey("activityErrorTotal");o--;a.setDataKey("activityErrorTotal",o)}var r=a.getDataKey("activityProgress");r--;a.setDataKey("activityProgress",r);a.switchPlanner()}},onSliderClose:function(e){var t=this.getData();var i=t.entityPath;var n=e.slider.getUrl();i=i.replace(/\#([^\#]+)\#/,"([\\d]+)");var a=n.match(new RegExp(i));if(a&&a[1]){this.loadNew(a[1],false,true)}},onPopupShow:function(e){var t=["menu-popup-toolbar_lead_list_menu","menu-popup-toolbar_deal_list_menu","menu-popup-toolbar_order_kanban_menu","menu-popup-toolbar_quote_list_menu"];var i=["menu-popup-toolbar_order_kanban_menu","menu-popup-toolbar_quote_list_menu"];if(t.indexOf(e.uniquePopupId)!==-1){var n=e.uniquePopupId.substr(11);this.addMenuAdditionalFields(n);if(i.indexOf(e.uniquePopupId)===-1){this.addMenuToggleCS(n)}}},setMultiSelectMode:function(){this.multiSelectMode=true;this.setKanbanDragMode()},initActionPanel:function(){var e=this.getData();var t=document.querySelector(".pagetitle-wrap");if(!t){t=document.getElementById("uiToolbarContainer")}this.actionPanel=new BX.UI.ActionPanel({renderTo:t,removeLeftPosition:true,maxHeight:56,parentPosition:"bottom"});this.actionPanel.draw();this.actionPanel.appendItem({id:"kanban_delete",text:BX.message("CRM_KANBAN_PANEL_DELETE"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-delete.svg",onclick:function(){BX.CRM.Kanban.Actions.deleteAll(this)}.bind(this)});if(this.getTypeInfoParam("canUseIgnoreItemInPanel")){this.actionPanel.appendItem({id:"kanban_ignore",text:BX.message("CRM_KANBAN_PANEL_IGNORE"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-ignore.svg",onclick:function(){BX.CRM.Kanban.Actions.ignore(this)}.bind(this)})}var i=[],n=[],a=this.getColumns(),o=this.getDropZoneArea().getDropZones();for(var r=0,s=a.length;r<s;r++){n.push({id:a[r].id,name:a[r].name})}for(var r=0,s=o.length;r<s;r++){var l=o[r].getData();if(e.entityType==="LEAD"&&l.type==="LOOSE"||e.entityType!=="LEAD"&&l.type){n.push({id:o[r].id,name:o[r].name})}}for(var r=0,s=n.length;r<s;r++){i.push({id:"kanban_column_"+n[r].id,column:n[r],text:BX.util.htmlspecialchars(n[r].name),onclick:function(e,t){t.menuWindow.close();BX.CRM.Kanban.Actions.changeColumn(this,t.column)}.bind(this)})}this.actionPanel.appendItem({id:"kanban_column",text:e.entityType==="DEAL"||e.isDynamicEntity?BX.message("CRM_KANBAN_PANEL_STAGE"):BX.message("CRM_KANBAN_PANEL_STATUS"),items:i,icon:e.entityType==="DEAL"||e.isDynamicEntity?"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-stage.svg":"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-status.svg"});if(e.categories&&e.categories.length){var i=[],n=e.categories;for(var r=0,s=n.length;r<s;r++){i.push({id:"kanban_category_"+n[r].ID,category:n[r],text:BX.util.htmlspecialchars(n[r].NAME),onclick:function(e,t){t.menuWindow.close();BX.CRM.Kanban.Actions.changeCategory(this,t.category)}.bind(this)})}this.actionPanel.appendItem({id:"kanban_category",text:BX.message("CRM_KANBAN_PANEL_CATEGORY"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-fulling.svg",items:i})}if(typeof BX.Crm.EntityEditorUserSelector!=="undefined"){this.actionPanel.appendItem({id:"kanban_assigned",text:BX.message("CRM_KANBAN_PANEL_ASSIGNED"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-responsible.svg",onclick:function(e,t){setTimeout(function(){var e=BX.Crm.EntityEditorUserSelector.create("selector_assigned",{callback:function(t,i){BX.CRM.Kanban.Actions.setAssigned(this,i);e.close()}.bind(this)});e.open(t.layout.container)}.bind(this),100)}.bind(this)})}if(this.getTypeInfoParam("canUseCreateTaskInPanel")){this.actionPanel.appendItem({id:"kanban_task",text:BX.message("CRM_KANBAN_PANEL_TASK"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-create.svg",onclick:function(){BX.CRM.Kanban.Actions.task(this)}.bind(this)})}if(this.getTypeInfoParam("canUseCallListInPanel")){this.actionPanel.appendItem({id:"kanban_calllist",text:BX.message("CRM_KANBAN_PANEL_CALLLIST"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-call.svg",onclick:function(){BX.CRM.Kanban.Actions.startCallList(this,false)}.bind(this)})}if(this.getTypeInfoParam("canUseMergeInPanel")){this.actionPanel.appendItem({id:"kanban_merge",text:BX.message("CRM_KANBAN_PANEL_MERGE"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-merge.svg",onclick:function(){BX.CRM.Kanban.Actions.merge(this)}.bind(this)})}},startActionPanel:function(){if(!this.actionPanel){this.initActionPanel()}this.actionPanel.showPanel()},stopActionPanel:function(){if(!this.actionPanel){return}this.actionPanel.hidePanel()},resetActionPanel:function(){if(this.actionPanel){this.actionPanel.removeItems();this.actionPanel=null}},reload:function(){this.resetMultiSelectMode();this.stopActionPanel();this.unSetKanbanDragMode();this.onApplyFilter()},calculateTotalCheckItems:function(){if(!this.actionPanel){this.initActionPanel()}this.actionPanel.setTotalSelectedItems(this.getChecked().length)},isMultiSelectMode:function(){return this.multiSelectMode},onMultiSelectMode:function(){if(this.multiSelectMode)return;this.multiSelectMode=true;BX.addClass(this.layout.gridContainer,"crm-kanban-multi-select-mode")},resetMultiSelectMode:function(){for(var e=0;e<this.getChecked().length;e++){this.getChecked()[e].unSelectItem();if(this.getChecked()[e].layout.container&&this.getChecked()[e].layout.container.classList.contains("main-kanban-item-disabled")){BX.removeClass(this.getChecked()[e].layout.container,"main-kanban-item-disabled")}}this.checkedItems=[];this.actionItems=[];this.multiSelectMode=false;BX.removeClass(this.layout.gridContainer,"crm-kanban-multi-select-mode")},onOpenEditorMenu:function(e,t){var i=this.getData();var n=this.getQuickEditor();if(n){i.customEditFields=[];var a=n.getControlById("main");for(var o=0,r=a._fields.length;o<r;o++){i.customEditFields.push(a._fields[o].getId())}this.setData(i)}var s=[],l=null;s.push({id:s.length+1,text:BX.message("CRM_KANBAN_CUSTOM_FIELDS_VIEW"),onclick:function(){this.showFieldsSelectPopup("view",e)}.bind(this)});s.push({id:s.length+1,text:BX.message("CRM_KANBAN_CUSTOM_FIELDS_EDIT"),onclick:function(){this.showFieldsSelectPopup("edit",e)}.bind(this)});l=new BX.PopupMenuWindow("crm-kanban-qiuck-form-add-fields-popup",e._addChildButton,s,{autohide:true,bindOptions:{forceBindPosition:true},autoHide:true,cacheable:false,closeByEsc:true});l.show();t["cancel"]=true},onConfigEditorScopeChange:function(){this.onApplyFilter()},onConfigEditorReset:function(){this.setAjaxParams({editorReset:"Y"});this.onApplyFilter()},onForceCommonEditorConfigScopeForAll:function(){this.setAjaxParams({editorSetCommon:"Y"});this.onApplyFilter()},insertItem:function(e){var t=null;var i=this.getColumn(e.getData().columnId);if(i){if(e!==i.getFirstItem()){t=i.getFirstItem()}else if(e===i.getFirstItem()&&i.getItemsCount()>1){t=i.getNextItemSibling(i.getFirstItem())}this.moveItem(e,e.getData().columnId,t)}else{this.removeItem(e)}},removeItem:function(e){var t=this.getItem(e);if(t){t.useAnimation=true;var i=t.getColumn();delete this.items[t.getId()];i.removeItem(t);t.dispose()}return t},openPartialEditor:function(e,t,i){var n=this.getData();var a={};var o={entityTypeId:n.entityTypeInt,entityId:e,fieldNames:i,context:a};a[this.getTypeInfoParam("stageIdKey")]=t;a["NOT_CHANGE_STATUS"]="Y";if(this.getTypeInfoParam("useFactoryBasedApproach")){o.title=BX.message("CRM_TYPE_ITEM_PARTIAL_EDITOR_TITLE");o.isController=true;o.entityTypeName=n.entityType;o.stageId=t}else{o.title=BX.message("CRM_KANBAN_REQUIRED_FIELDS_TITLE_"+n.entityType)}this.progressBarEditor=BX.Crm.PartialEditorDialog.create("progressbar-entity-editor",o);window.setTimeout(function(){this.progressBarEditor.open()}.bind(this),150)},getTypeInfoParam:function(e){var t=this.getTypeInfo();return t[e]?t[e]:false},getTypeInfo:function(){return this.getData().typeInfo}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:49:"/bitrix/js/crm/kanban/item.min.js?165484179126400";s:6:"source";s:29:"/bitrix/js/crm/kanban/item.js";s:3:"min";s:33:"/bitrix/js/crm/kanban/item.min.js";s:3:"map";s:33:"/bitrix/js/crm/kanban/item.map.js";}"*/
(function(){"use strict";BX.namespace("BX.CRM.Kanban");BX.CRM.Kanban.Item=function(t){BX.Kanban.Item.apply(this,arguments);this.container=null;this.timer=null;this.popupTooltip=null;this.plannerCurrent=null;this.fieldsWrapper=null;this.clientName=null;this.clientNameItems=[];this.useAnimation=false;this.isAnimationInProgress=false;this.changedInPullRequest=false;this.nextFieldsRenderingDisabled=false};BX.CRM.Kanban.Item.prototype={__proto__:BX.Kanban.Item.prototype,constructor:BX.CRM.Kanban.Item,lastPosition:{columnId:null,targetId:null},checked:false,clipTitle:function(t){var e=t;var i=e.split(" ");var a="<span>"+i[i.length-1]+"</span>";i.splice(i.length-1);e=i.join(" ")+" "+a;return e},setDataKey:function(t,e){var i=this.getData();i[t]=e;this.setData(i)},getDataKey:function(t){var e=this.getData();return e[t]},switchClass:function(t,e,i){if(i){BX.addClass(t,e)}else{BX.removeClass(t,e)}},switchVisible:function(t,e){if(e){t.style.display=""}else{BX.hide(t)}},getLastPosition:function(){return this.lastPosition},setLastPosition:function(){var t=this.getColumn();var e=t.getNextItemSibling(this);this.lastPosition={columnId:t.getId(),targetId:e?e.getId():0}},getBodyContainer:function(){if(!this.layout.bodyContainer){this.layout.bodyContainer=BX.create("div",{attrs:{className:"main-kanban-item-wrapper"}})}return this.layout.bodyContainer},render:function(){var t=null;var e=this.getData();var i=this.getGridData();if(e.special_type==="import"){t=this.getStartLayout();BX.onCustomEvent("Crm.Kanban.Grid:onSpecialItemDraw",[this,t]);this.grid.ccItem=this;this.getBodyContainer().style.background="none";return t}else if(e.special_type==="rest"){t=this.getIndustrySolutionsLayout();BX.onCustomEvent("Crm.Kanban.Grid:onSpecialItemDraw",[this,t]);this.grid.restItem=this;return t}if(!this.container){this.createLayout()}var a=this.getColumn();var n=a.getColor();var s=BX.util.hex2rgb(n);var r="rgba("+s.r+","+s.g+","+s.b+","+".7)";BX.style(this.container,"border-left","3px solid "+r);this.link.innerHTML=this.clipTitle(e.name);this.link.setAttribute("href",e.link);if(this.totalPrice){this.totalPrice.innerHTML=e.price_formatted}this.date.textContent=e.date;this.clientNameItems=[];if(e.contactId&&e.contactName&&BX.util.in_array("CLIENT",i.customFields)){this.clientNameItems.push(e.contactTooltip)}if(e.companyId&&e.companyName&&BX.util.in_array("CLIENT",i.customFields)){this.clientNameItems.push(e.companyTooltip)}if(this.clientNameItems.length){this.clientName.innerHTML=this.clientNameItems.join("<br>");this.switchVisible(this.clientName,true)}else{this.switchVisible(this.clientName,false)}if(this.planner){this.switchPlanner()}var c=["Phone","Email","Im"];for(var o=0,l=c.length;o<l;o++){var d=c[o];var h="crm-kanban-item-contact-"+d.toLowerCase()+"-disabled";BX.unbindAll(this["contact"+d]);if(e[d.toLowerCase()]){BX.bind(this["contact"+d],"click",BX.delegate(this.clickContact,this));this.switchClass(this["contact"+d],h,false)}else{BX.bind(this["contact"+d],"mouseover",BX.delegate(function(){var t=BX.data(BX.proxy_context,"type");this.showTooltip(BX.message("CRM_KANBAN_NO_"+t.toUpperCase()),BX.proxy_context)},this));BX.bind(this["contact"+d],"mouseout",BX.delegate(this.hideTooltip,this));this.switchClass(this["contact"+d],h,true)}}if(this.needRenderFields()){this.fieldsWrapper.innerHTML=null;this.layoutFields()}this.nextFieldsRenderingDisabled=false;t=this.container;return t},needRenderFields:function(){var t=this.fieldsWrapper?true:false;var e=this.getData().fields?true:false;var i=this.getGrid().getTypeInfoParam("doLayoutFieldsInItemRender");var a=!this.nextFieldsRenderingDisabled;return t&&e&&i&&a},preventNextFieldsRendering:function(){this.nextFieldsRenderingDisabled=true},getItemFields:function(){if(!this.fieldsWrapper){var t=this.getGridData();this.fieldsWrapper=BX.create("div",{props:{className:"crm-kanban-item-fields"}});if(this.getGrid().getTypeInfoParam("useRequiredVisibleFields")){this.switchVisible(this.link,true);this.switchVisible(this.date,true);this.switchVisible(this.clientName,true);if(this.total){this.switchVisible(this.total,true)}return this.fieldsWrapper}this.layoutFields()}return this.fieldsWrapper},layoutFields:function(){if(this.fieldsWrapper){for(var t=0;t<this.data.fields.length;t++){var e=this.data.fields[t].code;if(e==="TITLE"){this.switchVisible(this.link,true);continue}if(e==="DATE_CREATE"){this.switchVisible(this.date,true);continue}if(e==="CLIENT"){this.switchVisible(this.clientName,true);continue}if(e==="OPPORTUNITY"||e==="PRICE"){if(this.total){this.switchVisible(this.total,true)}continue}var i=null;if((e==="ASSIGNED_BY_ID"||e==="RESPONSIBLE_ID")&&this.data.fields[t].value.picture){i=' style="background-image: url('+encodeURI(this.data.fields[t].value.picture)+')"'}var a={props:{className:"crm-kanban-item-fields-item-value"}};if(e==="ASSIGNED_BY_ID"||e==="RESPONSIBLE_ID"){if(this.data.fields[t].html===true){var n="";var s="";if(this.data.fields[t].value.link===""){n='<span class="crm-kanban-item-fields-item-value-userpic"></span>';s='<span class="crm-kanban-item-fields-item-value-name">'+this.data.fields[t].value.title+"</span>"}else{n='<a class="crm-kanban-item-fields-item-value-userpic" href="'+this.data.fields[t].value.link+'"'+i+"></a>";s='<a class="crm-kanban-item-fields-item-value-name" href="'+this.data.fields[t].value.link+'">'+this.data.fields[t].value.title+"</a>"}a["html"]='<div class="crm-kanban-item-fields-item-value-user">'+n+s+"</div>"}else{a["text"]=this.getMessage("noname")}}else if(e==="ORDER_STAGE"){var r="";if(this.data.fields[t].value.code==="PAID"){r="paid"}else if(this.data.fields[t].value.code==="SENT_NO_VIEWED"){r="send"}else if(this.data.fields[t].value.code==="VIEWED_NO_PAID"){r="seen"}else if(this.data.fields[t].value.code==="PAYMENT_CANCEL"){r="cancel"}else if(this.data.fields[t].value.code==="REFUND"){r="refund"}a["html"]='<div class="crm-kanban-item-status crm-kanban-item-status-'+r+'">'+this.data.fields[t].value.title+"</div>"}else if(e==="DELIVERY_STAGE"){try{var c=this.data.fields[t].value.STAGE.TITLE;var e=this.data.fields[t].value.STAGE.CODE;var r=e==="SHIPPED"?"shipped":"no-shipped";a["html"]='<div class="crm-kanban-item-status crm-kanban-item-status-'+r+'">'+c+"</div>"}catch(t){}}else if(this.data.fields[t].type==="money"||this.data.fields[t].html===true){a["html"]=this.data.fields[t].value}else{a["text"]=this.data.fields[t].value}this.fieldsWrapper.appendChild(BX.create("div",{props:{className:"crm-kanban-item-fields-item"},children:[BX.create("div",{props:{className:"crm-kanban-item-fields-item-title"},html:this.data.fields[t].title}),BX.create("div",a)]}))}}},getItemFieldsEditor:function(){var t=this.getGridData();var e=BX.create("div",{});var i=BX.create("div",{props:{className:"crm-kanban-item-fields"},children:[e]});var a=BX.Crm.PartialEditorDialog.entityEditorUrls[t.entityType];if(this.data.fieldsEditor){var n=BX.Crm.EntityEditorModelFactory.create("kanban_model","",{data:this.data.fieldsEditor});BX.Crm.EntityEditor.create("kanban_"+t.entityType.toLowerCase()+"_"+this.getId(),{containerId:e,serviceUrl:a,entityTypeId:t.entityTypeInt,entityId:this.getId(),scheme:t.schemeInline,model:n,initialMode:"view",enableModeToggle:true,enableToolPanel:true,enableRequiredUserFieldCheck:true,userFieldManager:t.userFieldManagerInline})}return i},getCloseStartLayout:function(){return BX.create("div",{props:{className:"crm-kanban-item-contact-center-close"},events:{click:function(t){this.grid.toggleCC();t.stopPropagation(t)}.bind(this)}})},getCloseRestLayout:function(){return BX.create("div",{props:{className:"crm-kanban-item-industry-close"},events:{click:function(t){this.grid.toggleRest();t.stopPropagation(t)}.bind(this)}})},getStartLayout:function(){this.getCloseStartLayout();var t=this.getGridData();return BX.create("div",{props:{className:"crm-kanban-item-contact-center"},children:[BX.create("div",{dataset:{url:"contact_center"},props:{className:"crm-kanban-sidepanel"},children:[this.getCloseStartLayout(),BX.create("div",{props:{className:"crm-kanban-item-contact-center-title"},children:[BX.create("div",{props:{className:"crm-kanban-item-contact-center-title-item"},text:BX.message("CRM_KANBAN_EMPTY_CARD_CT_TITLE")}),BX.create("div",{props:{className:"crm-kanban-item-contact-center-title-item"},text:BX.message("CRM_KANBAN_EMPTY_CARD_CT_TEXT"+t.entityType)})]}),BX.create("div",{props:{className:"crm-kanban-item-contact-center-action"},children:[BX.create("div",{props:{className:"crm-kanban-item-contact-center-action-section"},children:[BX.create("a",{attrs:{href:"#"},props:{className:"crm-kanban-sidepanel crm-kanban-item-contact-center-action-item "+"crm-kanban-item-contact-center-action-item-chat"},text:BX.message("CRM_KANBAN_EMPTY_CARD_CT_CHAT"),dataset:{url:"ol_chat"}}),BX.create("a",{attrs:{href:"#"},props:{className:"crm-kanban-sidepanel crm-kanban-item-contact-center-action-item "+"crm-kanban-item-contact-center-action-item-crm-forms"},text:BX.message("CRM_KANBAN_EMPTY_CARD_CT_FORMS"),dataset:{url:"ol_forms"}}),BX.create("a",{attrs:{href:"#"},props:{className:"crm-kanban-sidepanel crm-kanban-item-contact-center-action-item "+"crm-kanban-item-contact-center-action-item-viber"},text:"Viber",dataset:{url:"ol_viber"}})]}),BX.create("div",{props:{className:"crm-kanban-item-contact-center-action-section"},children:[BX.create("a",{attrs:{href:"#"},props:{className:"crm-kanban-sidepanel crm-kanban-item-contact-center-action-item "+"crm-kanban-item-contact-center-action-item-call"},text:BX.message("CRM_KANBAN_EMPTY_CARD_CT_PHONES"),dataset:{url:"telephony"}}),BX.create("a",{attrs:{href:"#"},props:{className:"crm-kanban-sidepanel crm-kanban-item-contact-center-action-item "+"crm-kanban-item-contact-center-action-item-mail"},text:BX.message("CRM_KANBAN_EMPTY_CARD_CT_EMAIL"),dataset:{url:"email"}}),BX.create("a",{attrs:{href:"#"},props:{className:"crm-kanban-sidepanel crm-kanban-item-contact-center-action-item "+"crm-kanban-item-contact-center-action-item-facebook"},text:"Facebook",dataset:{url:"ol_facebook"}})]})]})]}),t.rights.canImport?BX.create("div",{children:[BX.create("div",{props:{className:"crm-kanban-item-contact-center-title crm-kanban-item-contact-center-title-import"},html:BX.message("CRM_KANBAN_EMPTY_CARD_IMPORT")})]}):null]})},getIndustrySolutionsLayout:function(){var t=[{text:BX.message("CRM_KANBAN_REST_DEMO_FILE_IMPORT")},{text:BX.message("CRM_KANBAN_REST_DEMO_FILE_EXPORT")},{text:BX.message("CRM_KANBAN_REST_DEMO_CRM_MIGRATION")},{text:BX.message("CRM_KANBAN_REST_DEMO_MARKET_2")},{text:BX.message("CRM_KANBAN_REST_DEMO_PUBLICATION_2")}];var e=document.createDocumentFragment();t.map(function(t,i){e.appendChild(BX.create("div",{props:{className:"crm-kanban-item-industry-list-item crm-kanban-item-industry-list-item-"+(i+1)},children:[BX.create("div",{props:{className:"crm-kanban-item-industry-list-item-img"}}),BX.create("div",{props:{className:"crm-kanban-item-industry-list-item-text"},text:t.text})]}))});return BX.create("div",{props:{className:"crm-kanban-item-industry"},children:[BX.create("div",{props:{className:"crm-kanban-item-industry-title"},text:BX.message("CRM_KANBAN_REST_DEMO_MARKET_SECTOR")}),BX.create("div",{props:{className:"crm-kanban-item-industry-list"},children:[e]}),BX.create("span",{props:{className:"ui-btn ui-btn-sm ui-btn-primary ui-btn-round crm-kanban-sidepanel"},dataset:{url:"rest_demo"},text:BX.message("CRM_KANBAN_REST_DEMO_SETUP")}),this.getCloseRestLayout()]})},selectItem:function(){this.checked=true;BX.addClass(this.checkedButton,"crm-kanban-item-checkbox-checked");BX.addClass(this.container,"crm-kanban-item-selected")},unSelectItem:function(){this.checked=false;BX.removeClass(this.checkedButton,"crm-kanban-item-checkbox-checked");BX.removeClass(this.container,"crm-kanban-item-selected")},createLayout:function(){var t=this.getGridData();this.container=BX.create("div",{props:{className:this.getGrid().getTypeInfoParam("kanbanItemClassName")},events:{click:function(t){var e=BX.findParent(t.target,{className:this.container.className});if(t.target!==this.container&&!e||e&&t.target.tagName==="A"||e&&t.target.tagName==="SPAN"){return}if(this.checked){this.getGrid().unCheckItem(this);if(this.getGrid().getChecked().length===0){this.getGrid().resetMultiSelectMode();this.getGrid().stopActionPanel()}}else{this.getGrid().checkItem(this);this.getGrid().onMultiSelectMode();this.getGrid().startActionPanel()}this.getGrid().calculateTotalCheckItems()}.bind(this),dblclick:function(){BX.fireEvent(this.link,"click")}.bind(this),mouseleave:function(){this.removeHoverClass(this.container)}.bind(this)}});BX.bind(this.container,"animationend",function(){BX.removeClass(this.layout.container,"main-kanban-item-new")}.bind(this));this.link=BX.create("a",{props:{className:"crm-kanban-item-title"},style:this.data.fields.length>0?{display:"none"}:{}});this.container.appendChild(this.link);if(this.options.data.return||this.options.data.returnApproach){this.repeated=BX.create("div",{props:{className:"crm-kanban-item-repeated"},text:this.options.data.returnApproach?BX.message("CRM_KANBAN_REPEATED_APPROACH_"+t.entityType):BX.message("CRM_KANBAN_REPEATED_"+t.entityType)});this.container.appendChild(this.repeated)}this.totalPrice=BX.create("div",{props:{className:"crm-kanban-item-total-price"}});this.total=BX.create("div",{props:{className:"crm-kanban-item-total"},style:this.data.fields.length>0?{display:"none"}:{},children:[this.totalPrice]});this.container.appendChild(this.total);this.clientName=BX.create("span",{props:{className:"crm-kanban-item-contact"}});this.container.appendChild(this.clientName);this.date=BX.create("div",{props:{className:"crm-kanban-item-date"},style:this.data.fields.length>0?{display:"none"}:{}});this.container.appendChild(this.date);this.checkedButton=BX.create("div",{props:{className:"crm-kanban-item-checkbox"},events:{click:function(){this.checked=!this.checked;this.checked?BX.addClass(this.checkedButton,"crm-kanban-item-checkbox-checked"):BX.removeClass(this.checkedButton,"crm-kanban-item-checkbox-checked")}.bind(this)}});this.container.appendChild(this.checkedButton);if(false&&this.data.fieldsEditor){this.container.appendChild(this.getItemFieldsEditor())}else if(this.data.fields.length>0){this.container.appendChild(this.getItemFields())}if(t.showActivity){this.activityExist=BX.create("span",{props:{className:"crm-kanban-item-activity"},events:{click:BX.delegate(this.showCurrentPlan,this)}});this.activityEmpty=BX.create("span",{props:{className:"crm-kanban-item-activity"},events:{click:BX.delegate(function(){this.showTooltip(this.getActivityMessage(t.entityType),BX.proxy_context,true)},this)}});this.activityPlan=BX.create("span",{props:{className:"crm-kanban-item-plan"},text:"+ "+BX.message("CRM_KANBAN_ACTIVITY_TO_PLAN"),events:{click:BX.delegate(this.showPlannerMenu,this)}});this.planner=BX.create("div",{props:{className:"crm-kanban-item-planner"},children:[this.activityEmpty,this.activityExist,this.activityPlan]});this.container.appendChild(this.planner)}this.contactPhone=BX.create("span",{props:{className:"crm-kanban-item-contact-phone crm-kanban-item-contact-phone-disabled"},attrs:{"data-type":"phone"}});this.contactEmail=BX.create("span",{props:{className:"crm-kanban-item-contact-email crm-kanban-item-contact-email-disabled"},attrs:{"data-type":"email"}});this.contactIm=BX.create("span",{props:{className:"crm-kanban-item-contact-im crm-kanban-item-contact-im-disabled"},attrs:{"data-type":"im"}});this.contactBlock=BX.create("div",{props:{className:"crm-kanban-item-connect"},children:[this.contactPhone,this.contactEmail,this.contactIm]});this.container.appendChild(this.contactBlock);this.container.appendChild(this.createShadow())},isChecked:function(){return this.checked},getActivityMessage:function(t){var e=BX.create("span");e.innerHTML=BX.message("CRM_KANBAN_ACTIVITY_CHANGE_"+t);var i=e.querySelector(".crm-kanban-item-activity-link");BX.bind(i,"click",function(){this.showPlannerMenu(this.activityPlan);this.popupTooltip.destroy()}.bind(this));return e},getPreloader:function(){return'<div class="crm-kanban-preloader-wapper">\n\t\t\t\t\t\t\t\t<div class="crm-kanban-preloader">\n\t\t\t\t\t\t\t\t\t<svg class="crm-kanban-circular" viewBox="25 25 50 50">\n\t\t\t\t\t\t\t\t\t\t<circle class="crm-kanban-path" cx="50" cy="50" r="20" fill="none" stroke-width="1" stroke-miterlimit="10"/>\n\t\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>'},loadCurrentPlan:function(){this.getGrid().ajax({action:"activities",entity_id:this.getId()},function(t){this.plannerCurrent.setContent(t);this.plannerCurrent.adjustPosition()}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this),"html")},showCurrentPlan:function(){this.plannerCurrent=BX.PopupWindowManager.create("kanban_planner_current",BX.proxy_context,{closeIcon:false,autoHide:true,className:"crm-kanban-popup-plan",closeByEsc:true,contentColor:"white",angle:true,offsetLeft:15,overlay:{backgroundColor:"transparent",opacity:"0"},events:{onAfterPopupShow:BX.delegate(this.loadCurrentPlan,this),onPopupClose:function(){this.plannerCurrent.destroy();BX.removeClass(this.container,"crm-kanban-item-hover");BX.unbind(window,"scroll",BX.proxy(this.adjustPopup,this))}.bind(this)}});this.plannerCurrent.setContent(this.getPreloader());this.plannerCurrent.show();BX.bind(window,"scroll",BX.proxy(this.adjustPopup,this))},clickContact:function(){var t=BX.data(BX.proxy_context,"type");var e=this.getContactInfo(t);if(typeof e==="object"&&Object.keys(e).length>1){this.showManyContacts(e,t)}else{this.showSingleContact(e,t)}},clickContactItem:function(t,e){var i=this.getData();if(e.type==="phone"&&typeof BXIM!=="undefined"){BXIM.phoneTo(e.value,{ENTITY_TYPE:e.clientType!==undefined?e.clientType:i.contactType,ENTITY_ID:e.clientId!==undefined?e.clientId:i.contactId})}else if(e.type==="im"&&typeof BXIM!=="undefined"){BXIM.openMessengerSlider(e.value,{RECENT:"N",MENU:"N"})}else if(e.type==="email"){var a=BX.CrmActivityEditor&&BX.CrmActivityEditor.items["kanban_activity_editor"];var n=top.BX.Bitrix24&&top.BX.Bitrix24.Slider;if(a&&BX.CrmActivityProvider&&n){var s=this.getGridData();BX.CrmActivityEditor.items["kanban_activity_editor"].addEmail({ownerType:s.entityType,ownerID:i.id,communications:[{type:"EMAIL",value:e.value,entityId:i.id,entityType:s.entityType,entityTitle:i.name}],communicationsLoaded:true})}else{top.location.href="mailto:"+e.value}}},showManyContacts:function(t,e){var i=[];var a=[];if(Array.isArray(t)){t={0:t}}for(var n in t){if(n==="company"||n==="contact"){i.push({delimiter:true,text:this.getMessage(n)})}a=t[n];for(var s=0,r=a.length;s<r;s++){var c="";var o="";var l=this.getData();if(n==="company"){c="CRM_COMPANY";o=l.companyId}else if(n==="contact"){c="CRM_CONTACT";o=l.contactId}i.push({value:a[s]["value"],type:e,clientType:c,clientId:o,text:a[s]["value"]+" ("+a[s]["title"]+")",onclick:BX.proxy(this.clickContactItem,this)})}}BX.PopupMenu.show("kanban_contact_menu_"+e+this.getId(),BX.proxy_context,i,{autoHide:true,zIndex:1200,offsetLeft:20,angle:true,closeByEsc:true,events:{onPopupClose:function(){BX.removeClass(this.container,"crm-kanban-item-hover");BX.unbind(window,"scroll",BX.proxy(this.adjustPopup,this))}.bind(this)}});BX.bind(window,"scroll",BX.proxy(this.adjustPopup,this))},showSingleContact:function(t,e){var i=this.getSingleContactCategory(t);if(!Array.isArray(i)){i=[i]}this.clickContactItem(0,{value:typeof i[0]["value"]!=="undefined"?i[0]["value"]:i[0],type:e})},getSingleContactCategory:function(t){return typeof t==="object"?t[Object.keys(t)[0]]:t},getMessage:function(t){return BX.CRM.Kanban.Item.messages[t]||""},selectPlannerMenu:function(t,e){BX.onCustomEvent("Crm.Kanban:selectPlannerMenu");var i=this.getGridData();if(e.type==="meeting"||e.type==="call"){(new BX.Crm.Activity.Planner).showEdit({TYPE_ID:BX.CrmActivityType[e.type],OWNER_TYPE:i.entityType,OWNER_ID:this.getId()})}else if(e.type==="task"){if(typeof window["taskIFramePopup"]!=="undefined"){var a={UF_CRM_TASK:[BX.CrmOwnerTypeAbbr.resolve(i.entityType)+"_"+this.getId()],TITLE:"CRM: ",TAGS:"crm"};window["taskIFramePopup"].add(a)}}else if(e.type==="visit"){var n=i.visitParams;n.OWNER_TYPE=i.entityType;n.OWNER_ID=this.getId();BX.CrmActivityVisit.create(n).showEdit()}var s=BX.PopupMenu.getCurrentMenu();if(s){s.close()}},getPlannerMenu:function(){var t=this.getGrid().getData();return[{type:"call",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_CALL"),onclick:BX.delegate(this.selectPlannerMenu,this)},{type:"meeting",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_MEETING"),onclick:BX.delegate(this.selectPlannerMenu,this)},t.rights.canUseVisit?{type:"visit",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_VISIT"),onclick:BX.delegate(this.selectPlannerMenu,this)}:null,{type:"task",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_TASK"),onclick:BX.delegate(this.selectPlannerMenu,this)}]},showPlannerMenu:function(t){var e=BX.PopupMenu.create("kanban_planner_menu_"+this.getId(),t.isNode?t:this.activityPlan,this.getPlannerMenu(),{className:"crm-kanban-planner-popup-window",autoHide:true,offsetLeft:50,angle:true,overlay:{backgroundColor:"transparent",opacity:"0"},events:{onPopupClose:function(){BX.removeClass(this.container,"crm-kanban-item-hover");BX.unbind(window,"scroll",BX.proxy(this.adjustPopup,this));e.destroy()}.bind(this)}});BX.addCustomEvent(window,"Crm.Kanban:selectPlannerMenu",function(){e.destroy()});e.show();BX.bind(window,"scroll",BX.proxy(this.adjustPopup,this))},switchPlanner:function(){var t=this.getData();var e=this.getColumn();var i=e.getData();if(t.activityProgress>0){this.switchVisible(this.activityExist,true);this.switchVisible(this.activityEmpty,false);this.setActivityExistInnerHtml()}else{var a=this.getGrid().getData();this.switchVisible(this.activityExist,false);this.switchVisible(this.activityPlan,true);this.switchVisible(this.activityEmpty,true);if(a.reckonActivitylessItems&&a.userId==t.assignedBy){this.activityEmpty.innerHTML=BX.message("CRM_KANBAN_ACTIVITY_MY")+(i.type==="PROGRESS"?" <span>1</span>":"")}else{this.activityEmpty.innerHTML=BX.message("CRM_KANBAN_ACTIVITY_MY")}}},setActivityExistInnerHtml:function(){if(this.activityExist!==undefined){var t=this.getData();var e=this.getColumn();var i=e.getData();this.activityExist.innerHTML=BX.message("CRM_KANBAN_ACTIVITY_MY")+(t.activityErrorTotal&&i.type==="PROGRESS"?" <span>"+t.activityErrorTotal+"</span>":"")}},showTooltip:function(t,e,i){this.popupTooltip=new BX.PopupWindow("kanban_tooltip",BX.proxy_context,{className:i?"crm-kanban-without-tooltip crm-kanban-without-tooltip-white":"crm-kanban-without-tooltip crm-kanban-tooltip-animate",offsetLeft:14,darkMode:i?false:true,overlay:i?{background:"black",opacity:0}:null,closeByEsc:true,angle:true,autoHide:true,content:t,events:{onPopupClose:function(){BX.unbind(window,"scroll",BX.proxy(this.adjustPopup,this))}.bind(this)}});BX.bind(window,"scroll",BX.proxy(this.adjustPopup,this));this.popupTooltip.show()},hideTooltip:function(){this.popupTooltip.destroy()},createShadow:function(){return BX.create("div",{props:{className:"crm-kanban-item-shadow"}})},removeHoverClass:function(t){BX.removeClass(t,"crm-kanban-item-event");BX.removeClass(t,"crm-kanban-item-hover")},adjustPopup:function(){var t=BX.PopupWindowManager.getCurrentPopup();if(!t){if(e){var e=BX.PopupMenu.getCurrentMenu();t=e.getPopupWindow()}}if(t){t.adjustPosition()}},onDragDrop:function(t,e,i){this.dropChangedInPullRequest();this.hideDragTarget();var a,n,s;a=this.getGrid().getItemByElement(t);a.dropChangedInPullRequest();n=new BX.Kanban.DragEvent;n.setItem(a);n.setTargetColumn(this.getColumn());n.setTargetItem(this);BX.onCustomEvent(this.getGrid(),"Kanban.Grid:onBeforeItemMoved",[n]);if(!n.isActionAllowed()){return}s=this.getGrid().moveItem(a,this.getColumn(),this);if(s){BX.onCustomEvent(this.getGrid(),"Kanban.Grid:onItemMoved",[a,this.getColumn(),this])}if(a.getColumn().getId()===this.getColumn().getId()){this.getGrid().resetMultiSelectMode();this.getGrid().cleanSelectedItems()}},onDragStart:function(){if(this.dragElement){return}if(!this.checked||this.grid.getChecked().length===1){this.grid.resetMultiSelectMode()}var t,e;if(this.grid.getChecked().length>1){var i=this.grid.getChecked().reverse();this.dragElement=BX.create("div",{props:{className:"main-kanban-item-drag-multi"}});for(var a=0;a<i.length&&a<3;a++){BX.onCustomEvent(this.getGrid(),"Kanban.Grid:onItemDragStart",[i[a]]);var n=i[a].getContainer().cloneNode(true);n.style.width=i[a].getContainer().offsetWidth+"px";this.getContainer().maxHeight=i[0].getContainer().offsetHeight+"px";this.dragElement.appendChild(n)}for(var a=0;a<i.length;a++){i[a].getContainer().classList.add("main-kanban-item-disabled")}document.body.appendChild(this.dragElement);return}BX.onCustomEvent(this.getGrid(),"Kanban.Grid:onItemDragStart",[this]);t=this.getContainer();e=this.getBodyContainer();this.getContainer().classList.add("main-kanban-item-disabled");this.dragElement=t.cloneNode(true);this.dragElement.style.position="absolute";this.dragElement.style.width=e.offsetWidth+"px";this.dragElement.className="main-kanban-item main-kanban-item-drag";document.body.appendChild(this.dragElement)},makeDroppable:function(){if(!this.isDroppable()){return}var t=this.getContainer();t.onbxdestdraghover=BX.delegate(this.onDragEnter,this);t.onbxdestdraghout=BX.delegate(this.onDragLeave,this);t.onbxdestdragfinish=BX.delegate(this.onDragDrop,this);t.onbxdestdragstop=BX.delegate(this.onItemDragEnd,this);jsDD.registerDest(t,5);if(this.getGrid().getDragMode()!==BX.Kanban.DragMode.ITEM){this.disableDropping()}},getContactInfo:function(t){var e=this.getData();return e[t]},getStageId:function(){return this.getData().stageId},animate:function(t){var e=t.duration;var i=t.draw;var a=t.timing||function(t){return t};var n=t.useAnimation&&!this.isAnimationInProgress||false;var s=performance.now();return new Promise(function(t,r){if(!n){this.isAnimationInProgress=false;return t()}var c=this;c.isAnimationInProgress=true;requestAnimationFrame(function n(r){var o=(r-s)/e;if(o>1){o=1}var l=a(o);i(l);if(o<1){requestAnimationFrame(n)}if(l===1){c.isAnimationInProgress=false;t()}}.bind(this))}.bind(this))},setChangedInPullRequest:function(){this.changedInPullRequest=true},dropChangedInPullRequest:function(){this.changedInPullRequest=false},isChangedInPullRequest:function(){return this.changedInPullRequest===true}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:51:"/bitrix/js/crm/kanban/column.min.js?165484179119047";s:6:"source";s:31:"/bitrix/js/crm/kanban/column.js";s:3:"min";s:35:"/bitrix/js/crm/kanban/column.min.js";s:3:"map";s:35:"/bitrix/js/crm/kanban/column.map.js";}"*/
(function(){BX.namespace("BX.CRM.Kanban");BX.CRM.Kanban.Column=function(t){BX.Kanban.Column.apply(this,arguments)};BX.CRM.Kanban.Column.prototype={__proto__:BX.Kanban.Column.prototype,constructor:BX.CRM.Kanban.Column,renderSubtitleTime:6,subtitleNode:null,pathToAdd:null,editorNodeWaiting:null,editorNodeIsBlock:null,editorNodeIsVisible:false,editorNode:null,editorNodeContainer:null,editorNodeCreate:null,editorNodeSelectFields:null,editorNodeSelectPopup:null,editorLoaded:false,editorOpen:false,quickFormSaveButton:null,quickFormCancelButton:null,editorId:null,editor:null,loader:null,isKeyMetaPressed:false,clickStatus:null,animationDuration:800,cancelEditHandler:null,blockSize:20,currencyFormat:function(t,e,i){var n="",o;if(typeof BX.Currency==="undefined"){return t}i=!!i;o=BX.Currency.getCurrencyFormat(e);if(!!o&&typeof o==="object"){o.CURRENT_DECIMALS=o.DECIMALS;o.HIDE_ZERO="Y";if(o.HIDE_ZERO==="Y"&&t==parseInt(t,10)){o.CURRENT_DECIMALS=0}n=BX.util.number_format(t,o.CURRENT_DECIMALS,o.DEC_POINT,o.THOUSANDS_SEP);if(i){n=o.FORMAT_STRING.replace(/(^|[^&])#/,"$1"+n)}}return n},decPrice:function(t){var e=this.getData();e.sum=parseFloat(e.sum)-t;this.setData(e)},incPrice:function(t){var e=this.getData();e.sum=parseFloat(e.sum)+t;this.setData(e)},getAddColumnButton:function(){var t=this.getData();if(t.type==="WIN"){this.layout.info.style.marginRight="0";return BX.create("div")}else{return BX.Kanban.Column.prototype.getAddColumnButton.apply(this,arguments)}},getAddPath:function(){if(this.pathToAdd!==null){return this.pathToAdd}var t=this.getGridData();var e=t.entityType.toLowerCase();var i,n;if(e==="invoice"){i="crm_invoice_toolbar"}else if(e==="order"){i="toolbar_order_kanban"}else{i="toolbar_"+e+"_list"}if(BX(i)){n=BX(i).querySelector("a");if(BX.type.isDomNode(n)){this.pathToAdd=n.getAttribute("href");this.pathToAdd+=this.pathToAdd.indexOf("?")===-1?"?":"&"}}return this.pathToAdd},addItem:function(t,e){if(!(t instanceof BX.Kanban.Item)){throw new Error("item must be an instance of BX.Kanban.Item")}if(t.layout.container&&t.layout.container.classList.contains("main-kanban-item-disabled")){BX.removeClass(t.layout.container,"main-kanban-item-disabled")}t.setColumnId(this.getId());if(t.checked){t.unSelectItem()}var i=BX.util.array_search(e,this.items);var n=this.getItems();var o=false;for(itemId in n){if(n[itemId].id===t.getId()){o=true}}if(!o){if(i>=0){this.items.splice(i,0,t)}else{this.items.push(t)}if(t.isCountable()){this.incrementTotal()}}t.animate({duration:this.animationDuration,draw:function(e){t.layout.container.style.opacity=e*100+"%"},useAnimation:t.useAnimation}).then(function(){BX.Event.EventEmitter.emit("Crm.Kanban.Column:onItemAdded",{item:t,targetColumn:this,beforeItem:e})}.bind(this));if(this.getGrid().isRendered()){this.render()}},addItems:function(t,e){if(!t){t=this.getGrid().getChecked()}var i=[];var n=BX.util.array_search(e,this.items);var o=0;var r=this.getPreviousItemSibling(e);if(r){o=r.getId()}for(var s=0;s<t.length;s++){t[s].visible=true;if(t[s].getColumn()!==this){t[s].getColumn().decPrice(t[s].data.price);t[s].getColumn().renderSubTitle();this.incPrice(t[s].data.price)}if(t[s].layout.container&&t[s].layout.container.classList.contains("main-kanban-item-disabled")){BX.removeClass(t[s].layout.container,"main-kanban-item-disabled")}t[s].setColumnId(this.getId());if(t[s].checked){t[s].unSelectItem()}var a=BX.util.array_search(t[s],this.items);if(e){if(a>=0){this.items.splice(a,0,t[s])}else{this.items.splice(n,0,t[s])}}else{this.items.splice(this.items.length,0,t[s])}if(t[s].isCountable()){this.incrementTotal()}t[s].parentColumn=null;i.push(t[s].getId())}this.getGrid().ajax({action:"status",entity_id:i,prev_entity_id:o,status:this.getId()},function(t){if(t&&t.error){BX.Kanban.Utils.showErrorDialog(t.error,true)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this));if(this.getGrid().isRendered()){var d=[];for(var u in this.items){if(!BX.util.in_array(this.items[u].id,d)){d.push(this.items[u].id)}}this.render();this.layout.total.textContent=d.length}},onDragDrop:function(t,e,i){this.hideDragTarget();var n,o;var r=this.getGrid().getItemByElement(t);n=new BX.Kanban.DragEvent;n.setItem(r);n.setTargetColumn(this);BX.onCustomEvent(this.getGrid(),"Kanban.Grid:onBeforeItemMoved",[n]);o=this.getGrid().moveItem(r,this);if(o){BX.onCustomEvent(this.getGrid(),"Kanban.Grid:onItemMoved",[r,this,null])}},processQuickEditor:function(){this.editor.save()},resetQuickEditor:function(){this.editorNodeContainer.style.height=this.editorNodeContainer.offsetHeight+"px";this.editorNodeContainer.innerHTML=""},getQuickEditor:function(){return this.editor},showQuickEditor:function(t){if(!t){this.editorOpen=true}this.getBody().scrollTop=0;var e=this.getGridData();var i=e.entityType;var n=e.params.CATEGORY_ID?parseInt(e.params.CATEGORY_ID):0;this.editorId="quick_editor_v6_"+this.getId()+"_"+i.toLowerCase()+"_"+n;if(!this.getGrid().getTypeInfoParam("isQuickEditorEnabled")){return}var o=this.getGrid().getTypeInfoParam("useFactoryBasedApproach");if(typeof e.quickEditorPath[i.toLowerCase()]==="undefined"&&!o){return}var r={PARAMS:e.params};r[this.getGrid().getTypeInfoParam("stageIdKey")]=this.getId();var s=this.getGrid().getTypeInfoParam("defaultQuickFormFields");if(!this.editorNodeContainer.innerHTML){if(!t){this.layout.subTitleAddButton.classList.add("crm-kanban-column-add-item-button-wait");this.disabledAddButton()}if(o){BX.ajax.runAction("crm.api.item.getEditor",{data:{entityTypeId:e.entityTypeInt,id:0,stageId:this.getId(),categoryId:e.params.CATEGORY_ID?e.params.CATEGORY_ID:0,guid:this.editorId,configId:e.editorConfigId,params:{ENABLE_PERSONAL_CONFIGURATION_UPDATE:true,ENABLE_COMMON_CONFIGURATION_UPDATE:true,ENABLE_CONFIG_SCOPE_TOGGLE:true,ENABLE_SETTINGS_FOR_ALL:true}}}).then(function(e){var i=BX.processHTML(e.data.html);this.editorNodeContainer.innerHTML=e.data.html;this.editorNodeContainer.appendChild(this.editorNodeCreate);this.editorNode.style.height="0px";BX.ajax.processScripts(i.SCRIPT,undefined,function(){var e=setInterval(function(){if(this.editorNodeContainer.offsetHeight<150){return}if(!this.editorOpen){this.layout.subTitleAddButton.classList.remove("crm-kanban-column-add-item-button-wait");return}if(t){return}this.editorNode.style.height=this.editorNodeContainer.offsetHeight+"px";this.layout.subTitleAddButton.classList.remove("crm-kanban-column-add-item-button-wait");var i=function(){this.editorNode.style.height=null;BX.unbind(this.editorNode,"transitionend",i)}.bind(this);BX.bind(this.editorNode,"transitionend",i);clearInterval(e)}.bind(this),100)}.bind(this))}.bind(this))}else{BX.ajax.post(e.quickEditorPath[i.toLowerCase()],{ACTION:"PREPARE_EDITOR_HTML",ACTION_ENTITY_TYPE_NAME:i,ACTION_ENTITY_ID:0,GUID:this.editorId,CONFIG_ID:e.editorConfigId,FORCE_DEFAULT_CONFIG:"N",FORCE_DEFAULT_OPTIONS:"Y",IS_EMBEDDED:"Y",ENABLE_CONFIG_SCOPE_TOGGLE:"Y",ENABLE_CONFIGURATION_UPDATE:"Y",ENABLE_REQUIRED_USER_FIELD_CHECK:"Y",ENABLE_FIELDS_CONTEXT_MENU:"N",FIELDS:s,CONTEXT:r},function(e){this.editorNodeContainer.innerHTML=e;this.editorNodeContainer.appendChild(this.editorNodeCreate);if(!this.editorOpen){this.layout.subTitleAddButton.classList.remove("crm-kanban-column-add-item-button-wait");return}if(t){return}this.editorNode.style.height="0px";var i=setInterval(function(){if(this.editorNodeContainer.offsetHeight<150){return}this.editorNode.style.height=this.editorNodeContainer.offsetHeight+"px";this.layout.subTitleAddButton.classList.remove("crm-kanban-column-add-item-button-wait");var t=function(){this.editorNode.style.height=null;BX.unbind(this.editorNode,"transitionend",t)}.bind(this);BX.bind(this.editorNode,"transitionend",t);clearInterval(i)}.bind(this),100)}.bind(this))}}else{this.getLoader().hide();this.hideQuickEditorLoader()}if(!this.editorLoaded){BX.addCustomEvent(window,"BX.Crm.EntityEditor:onInit",function(t,e){if(t.getId()===this.editorId){this.editor=t}}.bind(this));BX.addCustomEvent(window,"onCrmEntityCreateError",function(t){if(typeof t.error!=="undefined"){this.hideQuickEditorLoader();this.openQuickFormPartialEditor(Object.keys(t.checkErrors))}}.bind(this));if(!this.cancelEditHandler){this.cancelEditHandler=function(t){this.hideQuickEditorLoader()}.bind(this);BX.addCustomEvent(window,"BX.Crm.EntityEditor:onFailedValidation",this.cancelEditHandler);BX.addCustomEvent(window,"BX.Crm.EntityEditor:onRestrictionAction",this.cancelEditHandler)}BX.addCustomEvent(window,"BX.Crm.EntityEditorAjax:onSubmitFailure",function(t){if(this.editorOpen){this.quickFormSaveButton.classList.remove("ui-btn-wait");this.editorNode.classList.remove("crm-kanban-quick-form-wait");var e="";var i=[];for(var n in t){if(t.hasOwnProperty(n)&&t[n].message){if(t[n].code==="CRM_FIELD_ERROR_REQUIRED"&&t[n].customData&&t[n].customData.fieldName){i.push(t[n].customData.fieldName)}e+=t[n].message+", "}}if(i.length>0){this.openQuickFormPartialEditor(i)}else{BX.Kanban.Utils.showErrorDialog(BX.Text.encode(e),true)}}}.bind(this));BX.addCustomEvent(window,"onCrmEntityCreate",function(t){var e=t.sender.getContext();var i=this.getGrid().getTypeInfoParam("stageIdKey");if(e[i]===this.getId()){this.getGrid().loadNew(t.entityId,true)}if(this.editorOpen){this.hideQuickEditorLoader();t.isCancelled=true}}.bind(this));var a=this;BX.addCustomEvent("CRM.Kanban.Column:clickAddButton",function(){if(a!==this){a.hideQuickFormEditor();a.enabledAddButton();a.cleanEditor()}});BX.bind(window,"keydown",function(t){if(t.code==="MetaRight"||t.code==="MetaLeft"||t.code==="ControlRight"||t.code==="ControlLeft"){this.isKeyMetaPressed=true}}.bind(this));BX.bind(window,"keyup",function(t){if(t.code==="MetaRight"||t.code==="MetaLeft"||t.code==="ControlRight"||t.code==="ControlRight"){this.isKeyMetaPressed=false}}.bind(this));BX.bind(window,"keydown",function(t){if((t.code==="Enter"||t.code==="NumpadEnter")&&this.isKeyMetaPressed&&this.editorOpen){this.processQuickEditor();this.showQuickEditorLoader();BX.PreventDefault(t)}}.bind(this));BX.addCustomEvent(window,"BX.CRM.Kanban.Item.select",this.hideQuickFormEditor.bind(this));BX.addCustomEvent(window,"BX.CRM.Kanban.Item.select",this.enabledAddButton.bind(this));BX.addCustomEvent(window,"Kanban.Column:render",this.hideQuickFormEditor.bind(this));BX.addCustomEvent(window,"Kanban.Column:render",this.enabledAddButton.bind(this));BX.addCustomEvent(window,"Kanban.Grid:onItemDragStart",this.enabledAddButton.bind(this));BX.addCustomEvent(window,"Kanban.Grid:onItemDragStart",function(){if(this.editorOpen){BX.bind(this.editorNode,"transitionend",function(){for(var t=0;t<this.items.length;t++){this.items[t].makeDroppable()}}.bind(this))}this.hideQuickFormEditor();this.enabledAddButton()}.bind(this))}this.editorLoaded=true;this.layout.items.insertBefore(this.editorNode,this.layout.items.firstChild)},openQuickFormPartialEditor:function(t){if(!this.editorOpen||this.quickFormPartialEditor&&this.quickFormPartialEditor._isLocked){return}var e=new FormData(this.editor._ajaxForm._elementNode),i={};var n=e.entries(),o=n.next(),r;while(!o.done){r=o.value;i[r[0]]=r[1];o=n.next()}var s=this.grid.getData();var a={};a[this.getGrid().getTypeInfoParam("stageIdKey")]=this.id;a["NOT_CHANGE_STATUS"]="Y";var d={entityTypeId:s.entityTypeInt,entityId:0,fieldNames:t,context:a,values:[],presetValues:i};if(this.getGrid().getTypeInfoParam("useFactoryBasedApproach")){d.title=BX.message("CRM_TYPE_ITEM_PARTIAL_EDITOR_TITLE");d.isController=true;d.entityTypeName=s.entityType;d.stageId=this.getId()}else{d.title=BX.message("CRM_KANBAN_REQUIRED_FIELDS_TITLE_"+s.entityType)}this.quickFormPartialEditor=BX.Crm.QuickFormPartialEditorDialog.create("quickform-partial-entity-editor",d);this.quickFormPartialEditor.open()},isEditorOpen:function(){return this.editorOpen},showQuickEditorLoader:function(){this.quickFormSaveButton.classList.add("ui-btn-wait");this.editorNode.classList.add("crm-kanban-quick-form-wait")},hideQuickEditorLoader:function(){this.quickFormSaveButton.classList.remove("ui-btn-wait");this.editorNode.classList.remove("crm-kanban-quick-form-wait")},hideQuickFormEditor:function(){if(!this.editorOpen){return}this.editorOpen=false;this.editorNode.style.height=this.editorNode.offsetHeight+"px";setTimeout(function(){this.editorNode.style.height="0px"}.bind(this),10)},disabledAddButton:function(){BX.addClass(this.layout.subTitleAddButton,"crm-kanban-column-add-item-button-event")},enabledAddButton:function(){BX.removeClass(this.layout.subTitleAddButton,"crm-kanban-column-add-item-button-event")},isQuickFormPopup:function(t){return BX.findParent(t,{className:"popup-window"})},isBoundToDocument:function(t){return!!t.closest("body")},isQuickFormEditor:function(t){return BX.findParent(t,{className:"ui-entity-editor-column-content"})},renderSubTitle:function(){var t=this.getData();var e=this.getGridData();if(this.canAddItem===null){this.canAddItem=true}if(this.getGrid().getTypeInfoParam("showTotalPrice")){if(!this.layout.subTitlePrice){this.layout.subTitlePriceText=BX.create("span",{attrs:{className:"crm-kanban-total-price-total"}});this.layout.subTitlePrice=BX.create("div",{attrs:{className:"crm-kanban-total-price"},children:[this.layout.subTitlePriceText]})}}else{this.layout.subTitlePrice=null}if(this.layout.subTitlePriceText){t.sum=parseFloat(t.sum);t.sum_old=t.sum_old?t.sum_old:t.sum_init;t.sum_init=t.sum;this.renderSubTitleAnimation(t.sum_old,t.sum,Math.abs(t.sum_old-t.sum)/20,this.layout.subTitlePriceText,function(i,n){i.innerHTML=this.currencyFormat(Math.round(n),e.currency,true);t.sum_old=t.sum}.bind(this));this.setData(t)}if(this.subtitleNode){return this.subtitleNode}var i="",n=true,o=false;if(t.sort===100&&this.getGrid().getTypeInfoParam("hasPlusButtonTitle")){o=true;i=e.isDynamicEntity?BX.message("CRM_KANBAN_PLUS_TITLE_DYNAMIC"):BX.message("CRM_KANBAN_PLUS_TITLE_"+e.entityType)}if(n){this.editorNode=BX.create("div",{props:{className:"crm-kanban-quick-form"},style:{height:"0px"},children:[this.editorNodeContainer=BX.create("div",{props:{className:"crm-kanban-quick-form-container"}})]});this.editorNodeCreate=BX.create("div",{props:{className:"crm-kanban-qiuck-form-buttons"},children:[this.quickFormSaveButton=BX.create("input",{attrs:{type:"button",value:BX.message("CRM_KANBAN_POPUP_SAVE"),className:"ui-btn ui-btn-sm ui-btn-primary"},events:{click:function(t){this.processQuickEditor();this.showQuickEditorLoader();BX.PreventDefault(t)}.bind(this)}}),this.quickFormCancelButton=BX.create("input",{attrs:{type:"button",value:BX.message("CRM_KANBAN_CONFIRM_N"),className:"ui-btn ui-btn-sm ui-btn-link"},events:{click:function(){this.enabledAddButton();this.hideQuickFormEditor();this.cleanEditor()}.bind(this)}})]})}var r=this.getGrid().getTypeInfoParam("stageIdKey");r=r.toLowerCase();if(this.canAddItem&&this.getGrid().getTypeInfoParam("isQuickEditorEnabled")){this.layout.subTitleAddButton=BX.create("div",{text:i,attrs:{className:"crm-kanban-column-add-item-button"},events:{click:n?function(t){if(document.getElementsByTagName("html")[0].classList.contains("bx-ie")){if(e.entityType==="LEAD"){BX.SidePanel.Instance.open("/crm/lead/details/0/?category_id="+e.params.CATEGORY_ID)}else if(e.entityType==="DEAL"){BX.SidePanel.Instance.open("/crm/deal/details/0/")}return}if(BX.hasClass(this.layout.subTitleAddButton,"crm-kanban-column-add-item-button-event")){return}this.disabledAddButton();if(!this.editorNodeContainer.innerHTML){var i=this.getGrid().getColumns();for(var n=0;n<i.length;n++){if(i[n]!==this){if(i[n].editor){i[n].editor.release();i[n].editor=null;i[n].editorOpen=false;i[n].editorLoaded=false;BX.cleanNode(i[n].editorNodeContainer)}i[n].hideQuickFormEditor();i[n].enabledAddButton();i[n].cleanEditor()}}this.showQuickEditor();return}BX.onCustomEvent(this,"CRM.Kanban.Column:clickAddButton",this);if(!this.editorNode.parentNode){this.layout.items.insertBefore(this.editorNode,this.layout.items.firstElementChild)}this.getBody().scrollTop=0;this.editorNode.style.height="0px";this.editorOpen=true;setTimeout(function(){this.editorNode.style.height=this.editorNodeContainer.offsetHeight+"px";var t=function(){this.editorNode.style.height=null;BX.unbind(this.editorNode,"transitionend",t)}.bind(this);BX.bind(this.editorNode,"transitionend",t);if(this.editor){this.editor.refreshLayout({reset:true})}}.bind(this),10)}.bind(this):null}})}else if(this.canAddItem){this.layout.subTitleAddButton=this.getAddPath()?BX.create("a",{text:i,attrs:{className:"crm-kanban-column-add-item-button",href:this.getAddPath()+r+"="+this.getId()}}):null}this.subtitleNode=BX.create("div",{children:[this.layout.subTitlePrice,n?this.layout.subTitleAddButton:this.getAddPath()?BX.create("a",{text:i,attrs:{className:"crm-kanban-column-add-item-button",href:this.getAddPath()+r+"="+this.getId()}}):null,this.editorNode]});if(o&&this.canAddItem){setTimeout(function(){this.showQuickEditor(true)}.bind(this))}return this.subtitleNode},cleanEditorNode:function(){BX.cleanNode(this.editorNodeContainer)},cleanEditor:function(){if(this.editor){this.editor.rollback();this.editor.refreshLayout()}},getLoader:function(){if(!this.loader){this.loader=new BX.Loader({target:this.editorNode})}return this.loader},renderSubTitleAnimation:function(t,e,i,n,o){var r=+t;var s=parseFloat(e);var a=this.renderSubtitleTime;if(r<s){(function(){if(r<=s){setTimeout(arguments.callee,a);n.textContent=BX.util.number_format(r,0,","," ");r=r+i}else{if(typeof o==="function"){o(n,e)}}})()}else if(r>s){(function(){if(r>=s){setTimeout(arguments.callee,a);n.textContent=BX.util.number_format(r,0,","," ");r=r-i}else{if(typeof o==="function"){o(n,e)}}})()}else if(typeof o==="function"){o(n,e)}},handleAddColumnButtonClick:function(t){var e=this.getGridData();if(e.rights&&e.rights.canAddColumn){BX.Kanban.Column.prototype.handleAddColumnButtonClick.apply(this,arguments)}else if(typeof BX.Intranet!=="undefined"){this.getGrid().accessNotify()}},switchToEditMode:function(){var t=this.getGridData();if(t.rights&&t.rights.canAddColumn){BX.Kanban.Column.prototype.switchToEditMode.apply(this,arguments)}else if(typeof BX.Intranet!=="undefined"){this.getGrid().accessNotify()}},focusTextBox:function(){setTimeout(function(){this.getTitleTextBox().focus()}.bind(this))},makeDroppable:function(){if(!this.isDroppable()){return}var t=this.getBody();t.onbxdestdraghover=BX.delegate(this.onDragEnter,this);t.onbxdestdraghout=BX.delegate(this.onDragLeave,this);t.onbxdestdragfinish=BX.delegate(this.onDragDrop,this);t.onbxdestdragstop=BX.delegate(this.onItemDragEnd,this);jsDD.registerDest(t,10);this.disableDropping()},removeItem:function(t){return new Promise(function(e,i){var n=false;this.items=this.items.filter(function(e){if(e===t){n=true;return false}return true});if(n){t.animate({duration:this.animationDuration,draw:function(e){t.layout.container.style.opacity=100-e*100+"%"},useAnimation:t.useAnimation}).then(function(i){if(t.isCountable()&&t.isVisible()){this.decrementTotal();this.getGrid().resetMultiSelectMode()}if(this.getGrid().isRendered()){this.render()}e()}.bind(this))}else{e()}}.bind(this))}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:52:"/bitrix/js/crm/kanban/dropzone.min.js?16548417913837";s:6:"source";s:33:"/bitrix/js/crm/kanban/dropzone.js";s:3:"min";s:37:"/bitrix/js/crm/kanban/dropzone.min.js";s:3:"map";s:37:"/bitrix/js/crm/kanban/dropzone.map.js";}"*/
(function(){"use strict";BX.namespace("BX.CRM.Kanban");BX.CRM.Kanban.DropZone=function(e){BX.Kanban.DropZone.apply(this,arguments);this.droppedItems=[]};BX.CRM.Kanban.DropZone.prototype={__proto__:BX.Kanban.DropZone.prototype,constructor:BX.CRM.Kanban.DropZone,onDragDrop:function(e,t,i){var o;var n=this.getGrid().getData();var r=this.getData();this.getGrid().dropZonesShow=true;if(this.getGrid().getChecked().length>1&&(n.entityType==="LEAD"&&r.type==="WIN"||n.entityType==="INVOICE")){this.getGrid().getPopupCancel(BX.message("CRM_KANBAN_MASS_CONVERT_DISABLE")).show();if(this.getGrid().getChecked().length>0){for(var s=0;s<this.getGrid().getChecked().length;s++){BX.removeClass(this.getGrid().getChecked()[s].layout.container,"main-kanban-item-disabled")}this.getGrid().resetMultiSelectMode()}return}var d=this.getGrid().getChecked();o=this.getGrid().getItemByElement(e);this.captureItem(o);this.getDropZoneArea().unsetActive();if(d.length>1){this.droppedItems=d;for(var s=0;s<this.droppedItems.length;s++){this.getGrid().hideItem(this.droppedItems[s]);if(o!==this.droppedItems[s]){this.droppedItems[s].getColumn().decPrice(this.droppedItems[s].data.price);this.droppedItems[s].getColumn().renderSubTitle()}}}},captureItem:function(e){var t;t=new BX.Kanban.DropZoneEvent;t.setItem(e);t.setDropZone(this);BX.onCustomEvent(this.getGrid(),"Kanban.DropZone:onBeforeItemCaptured",[t]);if(!t.isActionAllowed()){return}this.empty();this.droppedItem=e;this.getDropZoneArea().show();this.setCaptured();this.unsetActive();this.animateRemove(e.layout.container);this.getGrid().hideItem(e);BX.onCustomEvent(this.getGrid(),"Kanban.DropZone:onItemCaptured",[e,this]);this.captureTimeout=setTimeout(function(){this.empty();this.getDropZoneArea().hide();this.droppedItems=[];this.getGrid().dropZonesShow=false}.bind(this),this.getDropZoneArea().getDropZoneTimeout())},restore:function(){this.getGrid().dropZonesShow=false;if(this.captureTimeout){clearTimeout(this.captureTimeout)}if(this.droppedItem===null){return}var e=new BX.Kanban.DropZoneEvent;if(!e.isActionAllowed()){return}this.unsetActive();this.unsetCaptured();if(this.droppedItems.length>0){this.droppedItems=this.getGrid().getChecked();for(var t=0;t<this.droppedItems.length;t++){e.setItem(this.droppedItems[t]);e.setDropZone(this);BX.onCustomEvent(this.getGrid(),"Kanban.DropZone:onBeforeItemRestored",[e]);this.getGrid().unhideItem(this.droppedItems[t]);if(this.droppedItem!==this.droppedItems[t]){this.droppedItems[t].getColumn().incPrice(this.droppedItems[t].data.price);this.droppedItems[t].getColumn().renderSubTitle()}BX.onCustomEvent(this.getGrid(),"Kanban.DropZone:onItemRestored",[this.droppedItems[t],this])}this.droppedItem=null;return}e.setItem(this.droppedItem);e.setDropZone(this);BX.onCustomEvent(this.getGrid(),"Kanban.DropZone:onBeforeItemRestored",[e]);this.getGrid().unhideItem(this.droppedItem);BX.onCustomEvent(this.getGrid(),"Kanban.DropZone:onItemRestored",[this.droppedItem,this]);this.droppedItem=null},getContainer:function(){if(this.layout.container!==null){return this.layout.container}var e=[];e.push(this.getNameContainer());if(this.getId()!=="DELETED"){e.push(this.getCancelLink())}e.push(this.getBgContainer());this.layout.container=BX.create("div",{attrs:{className:"main-kanban-dropzone","data-id":this.getId()},children:e});this.makeDroppable();var t=[];for(var i in this.dropZoneArea.dropZones){t.push(this.dropZoneArea.dropZones[i])}if(t.length===1){this.layout.container.style.minWidth="auto";this.layout.container.style.maxWidth="none"}return this.layout.container},makeDroppable:function(){var e=this.getContainer();e.onbxdestdraghover=BX.delegate(this.onDragEnter,this);e.onbxdestdraghout=BX.delegate(this.onDragLeave,this);e.onbxdestdragfinish=BX.delegate(this.onDragDrop,this);jsDD.registerDest(e,4)}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:55:"/bitrix/js/crm/kanban/pullmanager.min.js?16548417914083";s:6:"source";s:36:"/bitrix/js/crm/kanban/pullmanager.js";s:3:"min";s:40:"/bitrix/js/crm/kanban/pullmanager.min.js";s:3:"map";s:40:"/bitrix/js/crm/kanban/pullmanager.map.js";}"*/
this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t){"use strict";var i=t.Reflection.namespace("BX.Crm.Kanban");var a=new WeakMap;var l=new WeakMap;var r=new WeakMap;var s=function(){function e(t){babelHelpers.classCallCheck(this,e);a.set(this,{writable:true,value:void 0});l.set(this,{writable:true,value:void 0});r.set(this,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,l,t);babelHelpers.classPrivateFieldSet(this,a,[]);babelHelpers.classPrivateFieldSet(this,r,false)}babelHelpers.createClass(e,[{key:"loadItem",value:function e(t){t=t||false;if(babelHelpers.classPrivateFieldGet(this,r)&&!t){return}var i=this.pop();if(i){babelHelpers.classPrivateFieldSet(this,r,true);babelHelpers.classPrivateFieldGet(this,l).loadNew(i,false,true).then(function(e){if(this.peek()){this.loadItem(true)}else{babelHelpers.classPrivateFieldSet(this,r,false)}}.bind(this))}}},{key:"push",value:function e(t){t=parseInt(t,10);var i=this.getAll().indexOf(t);if(i!==-1){this.splice(i)}babelHelpers.classPrivateFieldGet(this,a).push(t);return this}},{key:"pop",value:function e(){return babelHelpers.classPrivateFieldGet(this,a).shift()}},{key:"peek",value:function e(){return babelHelpers.classPrivateFieldGet(this,a).length?babelHelpers.classPrivateFieldGet(this,a)[0]:null}},{key:"getAll",value:function e(){return babelHelpers.classPrivateFieldGet(this,a)}},{key:"splice",value:function e(t){babelHelpers.classPrivateFieldGet(this,a).splice(t,1)}}]);return e}();var n=t.Reflection.namespace("BX.Crm.Kanban");var d=function(){function e(i){babelHelpers.classCallCheck(this,e);this.grid=i;this.queue=new s(this.grid);if(t.Type.isString(i.getData().moduleId)&&i.getData().userId>0){this.init()}}babelHelpers.createClass(e,[{key:"init",value:function e(){var i=this;t.Event.ready(function(){var e=BX.PULL;if(!e){console.error("pull is not initialized");return}e.subscribe({moduleId:i.grid.getData().moduleId,command:i.grid.getData().pullTag,callback:function e(a){if(t.Type.isString(a.eventName)){if(a.eventName==="ITEMUPDATED"){i.onPullItemUpdated(a)}else if(a.eventName==="ITEMADDED"){i.onPullItemAdded(a)}else if(a.eventName==="ITEMDELETED"){i.onPullItemDeleted(a)}else if(a.eventName==="STAGEADDED"){i.onPullStageAdded(a)}else if(a.eventName==="STAGEDELETED"){i.onPullStageDeleted(a)}else if(a.eventName==="STAGEUPDATED"){i.onPullStageUpdated(a)}}}});e.extendWatch(i.grid.getData().pullTag)})}},{key:"onPullItemUpdated",value:function e(t){if(this.updateItem(t)){this.queue.loadItem()}}},{key:"updateItem",value:function e(t){var i=this.grid.getItem(t.item.id);var a=t.item;if(i){var l=parseFloat(i.data.price);var r=i.data.columnId;for(var s in a.data){if(s in i.data){i.data[s]=a.data[s]}}i.rawData=a.rawData;i.setActivityExistInnerHtml();i.useAnimation=true;i.setChangedInPullRequest();this.grid.resetMultiSelectMode();i.preventNextFieldsRendering();this.grid.insertItem(i);var n=this.grid.getColumn(a.data.columnId);var d=parseFloat(a.data.price);if(r!==a.data.columnId){var u=this.grid.getColumn(r);u.decPrice(l);u.renderSubTitle();n.incPrice(d);n.renderSubTitle()}else{if(l<d){n.incPrice(d-l);n.renderSubTitle()}else if(l>d){n.decPrice(l-d);n.renderSubTitle()}}i.columnId=a.data.columnId;this.queue.push(i.id);return true}this.onPullItemAdded(t);return false}},{key:"onPullItemAdded",value:function e(t){this.addItem(t);this.queue.loadItem()}},{key:"addItem",value:function e(t){var i=this.grid.getItem(t.item.id);if(i){return}this.grid.addItemTop(t.item);this.queue.push(t.item.id)}},{key:"onPullItemDeleted",value:function e(i){if(!t.Type.isPlainObject(i.item)){return}this.grid.removeItem(i.item.id);var a=this.grid.getColumn(i.item.data.columnId);a.decPrice(i.item.data.price);a.renderSubTitle()}},{key:"onPullStageAdded",value:function e(t){this.grid.onApplyFilter()}},{key:"onPullStageDeleted",value:function e(t){this.grid.removeColumn(t.stage.id)}},{key:"onPullStageUpdated",value:function e(t){this.grid.onApplyFilter()}}]);return e}();n.PullManager=d;e.default=d})(this.BX.Crm.Kanban=this.BX.Crm.Kanban||{},BX);
/* End */
;
//# sourceMappingURL=kernel_crm_kanban.map.js